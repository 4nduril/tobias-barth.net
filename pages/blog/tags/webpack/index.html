<!DOCTYPE html>
<html lang="de">
<head><meta name="generator" content="Hexo 3.9.0">
	<meta charset="utf-8">
	<title>tobias-barth.net | Moderne Webentwicklung aus Köln</title>
	<meta name="description" content>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	<!--[if lt IE 9]>
		<link rel="stylesheet" href="/css/old-ie.css" />
	<![endif]-->

	<link rel="alternate" type="application/rss+xml" href="/blog/feed/rss.xml">

</head>
<body>
	<header class="site-head">
			<a href="/"><h1 class="in-site-head">tobias-barth.net</h1>
			<p class="tagline in-site-head">Moderne Webentwicklung aus Köln</p></a>
		</header>

</body></html>
		<main>
			<nav class="main-navi" id="main-navi">
				<ul>
					<li><a href="/portfolio" title="Meine Fähigkeiten, Arbeitsfelder und Beispielprojekte"><span class="fa fa-wrench"></span> Ich mache</a></li>
				<li><a href="/blog" title="Mein Blog über Webentwicklung und Ähnliches"><span class="fa fa-pencil"></span> Ich schreibe</a></li>
<!--					<li><a href="" title="Lernen Sie mich besser kennen"><span class="fa fa-user"></span> Ich bin</a></li>-->
				</ul>
			</nav>
		<div class="blog-textcontainer">

	
		<article id="Bundling-your-library-with-Webpack" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2020/05/Bundling-your-library-with-Webpack/">
	
		<h2 class="blog-post-title">Bundling your library with Webpack</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2020-05-08T15:59:34.000Z">08. Mai 2020</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h3><p>This article is part 7 of the series “Publish a modern JavaScript (or TypeScript) library”. Check out the motivation and links to other parts <a href="http://tobias-barth.net/blog/2019/07/Publish-a-modern-JavaScript-or-TypeScript-library/">in the introduction</a>.</p>
<p><strong>If you are not interested in the background and reasoning behind the setup, <a href="#bylww-conclusion">jump directly to the conclusion</a></strong></p>
<h3 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h3><p>In the last post we have established in which cases we may need to bundle our library – instead of just delivering transpiled files /modules. There are a few tools which help us to do so and we will look at the most important of them one after another.</p>
<p>As promised I will make the start with Webpack. Maybe most of you have had already contact with Webpack. Probably in the context of website/application bundling. Anyway, a short intro to what it is and does. It is a very versatile tool that was originally build around the concept of code-splitting. Of course it can do (and does) many more things than that but that was the initial, essential idea: make it possible and make it easy to split all of your application code into chunks of code that belongs together. So that the browser (the user) would not have to first download, parse and execute <strong>all</strong> of the app before anything works. But to be able to load only the right amount of code needed at the moment. Webpack is awesome at that.</p>
<p>The thing is, we don’t want to do that. We do not have an application, we have a library. There is either no need for splitting because our code really does only one thing (even if it is a complex thing). Or, we provide rather independent code blocks but then it’s the <em>application’s</em> job to put the right things in the right chunks. We can not assume anything about the library-user’s needs so they get to decide about splitting.</p>
<p>Then, what can Webpack do for us? It can take all of our carefully crafted modules, walk through their dependency structure like a tree and put them all together in one module – a bundle. Plus, it adds a tiny bit of runtime code to make sure, everything is consumable from outside as we expect it to.</p>
<p>Webpack, like all bundlers I can think of right now, works directly with the source code. It’s not like you have to, say, transpile it first and then Webpack starts its thing. But for Webpack to be able to understand your code and also to apply any transformation to it you may want, you need to use so-called <em>loaders</em>. There is a <code>babel-loader</code> that we can use for transpiling, TypeScript-loaders, even things like SVG- or CSS-loaders which allow us to import things in our JS/TS files that aren’t even related to JavaScript.</p>
<p>This article does not want and is not able to cover all the possibilities of what you can achieve with Webpack. If you want to learn more, consult the official <a href="https://webpack.js.org/">documentation</a>. It’s really good these days. (Back in my time … but anyway.)</p>
<h3 id="Our-goal"><a href="#Our-goal" class="headerlink" title="Our goal"></a>Our goal</h3><p>We have library code, written in plain JavaScript or TypeScript, no fancy imports. It needs to get transpiled according to our rules and result in one consumable file which people can import in their applications. Also, we want people to be able to just drop it in their HTML in form of a script tag. That is, we want to get a UMD module.</p>
<hr>
<h4 id="What-are-UMD-modules"><a href="#What-are-UMD-modules" class="headerlink" title="What are UMD modules?"></a>What are UMD modules?</h4><p>(If you already know our if you don’t want to know more than I mentioned in the paragraph before, feel free to skip to <a href="#bylww-starting">Starting with Webpack</a> or even to the <a href="#bylww-conclusion">Conclusion and final config</a>.)</p>
<p>UMD stands for Universal Module Definition. It combines the module systems Asynchronous Module Definition (AMD), CommonJS and exposure via a global variable for cases where no module system is in place. You can read the <a href="https://github.com/umdjs/umd">specification and its variants here</a>. Basically, a UMD module wraps the actual library code with a thin detection layer that tries to find out if it’s currently being executed in the context of one of the two mentioned module systems. In case it is, it exposes the library within that system (with <code>define</code> or <code>module.exports</code>). If not, it will assign the library’s exports to a global variable.</p>
<h3 id="Starting-with-Webpack"><a href="#Starting-with-Webpack" class="headerlink" title=" Starting with Webpack"></a><a name="bylww-starting"></a> Starting with Webpack</h3><p>This will be roughly the same as in the <a href="https://webpack.js.org/guides/author-libraries/">official documentation</a> of Webpack. But I will try to provide the complete configuration including optimizations and to comment it. Also note that I will omit many possibilities Webpack offers or simplify a few things here and there. That’s because this not a deep dive into Webpack but a what-you-should-know-when-bundling-a-library piece.</p>
<p>First we install Webpack and its command line interface:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D webpack webpack-cli</span><br></pre></td></tr></table></figure>
<p>Now we create a file called <code>webpack.config.js</code> within the root directory of our library. Let’s start with the absolute basics:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span> (<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: <span class="string">'./src/index.js'</span>, <span class="comment">// or './src/index.ts' if TypeScript</span></span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'library-starter.js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With <code>entry</code> we are defining the entry point into our library. Webpack will load this file first and build a tree of dependent modules from that point on. Also, together with a few other options that we will see in a bit, Webpack will expose all exports from that entry module to the outside world – our library’s consumers. The value is, as you can see, a string with a path that is reachable from the config file location.</p>
<p>The <code>output</code> key allows us to define what files Webpack should create. The <code>filename</code> prop makes running Webpack result in a bundle file with this name. The <code>path</code> is the folder where that output file is put in. Webpack also defaults to the <code>dist</code> that we defined here but you could change it, e.g. to <code>path.resolve(__dirname, &#39;output&#39;)</code>or something completely different. But ensure to provide an absolute path – it will not get expanded like the <code>entry</code> value.</p>
<h3 id="Problem-1-custom-syntax-like-JSX"><a href="#Problem-1-custom-syntax-like-JSX" class="headerlink" title="Problem 1: custom syntax like JSX"></a>Problem 1: custom syntax like JSX</h3><p>When we now run <code>npx webpack</code> on the command line, we expect it to result in a generated <code>dist/library-starter.js</code> file. Instead it fails with an error. In my <a href="https://github.com/4nduril/library-starter">library-starter example code</a> I use React’s JSX. As it is configured now, Webpack will refuse to bundle it because it encounters an “unexpected token” when it tries to parse the code. You see that Webpack needs to understand your code. We help with configuring an appropriate “loader”</p>
<p>If you use Babel for transpiling, install the Babel loader:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D babel-loader</span><br></pre></td></tr></table></figure>
<p>The rest of the Babel setup we need is already installed in our project.</p>
<p>If you instead are using TSC you’ll need <code>ts-loader</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D ts-loader</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong> I know there is also the <a href="https://github.com/s-panferov/awesome-typescript-loader">Awesome TypeScript Loader</a> but recently it seems to be the case that TS-Loader is faster and is the default choice for most users.</p>
<p>We now add the following to <code>webpack.config.js</code> :</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js (Babel)</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jsx?$/</span>, <span class="comment">// If you are using TypeScript: /\.tsx?$/</span></span><br><span class="line">        include: path.resolve(__dirname, <span class="string">'src'</span>),</span><br><span class="line">        use: [ &#123;</span><br><span class="line">          loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            cacheDirectory: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Or:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js (TSC)</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">        include: path.resolve(__dirname, <span class="string">'src'</span>),</span><br><span class="line">        use: [ &#123;</span><br><span class="line">          loader: <span class="string">'ts-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            transpileOnly: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Problem-2-Babels-runtime-helpers"><a href="#Problem-2-Babels-runtime-helpers" class="headerlink" title="Problem 2: Babels runtime helpers"></a>Problem 2: Babels runtime helpers</h3><p>In case we are using Babel for transpiling, Webpack now runs into the next error. It tries to resolve the helper and polyfill imports that Babel created for us but as <a href="http://tobias-barth.net/blog/2019/07/Transpile-modern-language-features-with-Babel/">we only declared them</a> as a <code>peerDependency</code> we haven’t installed them and so Webpack can’t put them into the bundle.</p>
<h4 id="Bundling-helpers"><a href="#Bundling-helpers" class="headerlink" title="Bundling helpers?"></a>Bundling helpers?</h4><p>As you remember, we deliberately did define <code>@babel/runtime-corejs3</code> as a peer dependency to make sure our delivered library is as small as possible and also allows the user to have at best only one version of it installed, keeping their application bundle smaller. Now, if we install it by ourselves and bundle it with Webpack, then all the benefit is gone. Yes, that’s right. We can of course tell Webpack that certain imports should be treated as “external” and we will in fact do that later on for the “react” dependency that our specific library has. But not for the runtime helpers.</p>
<p>Because remember why we are bundling: One of the reasons was to make it possible for a user to drop the bundle in a <code>script</code> tag into their page. To be able to do that with deps declared as external, also <em>those</em> have to be available as UMD package. This is the case for many things like React or Lodash but not for this runtime package. That means we have to bundle it together with our code. We could make a very sophisticated setup with several Webpack configs, one resulting in a bigger bundle for that specific use case and one for usual importing in an application. But <em>we reached already</em> the second goal: with our non-bundled build.</p>
<p>If your library uses non-JS/TS imports like CSS or SVGs or something like that, then of course you can think about how much it will save the users of your library if you go that extra mile. I am not going to cover that in this article. Maybe at a later point when we have all of our foundations in place.</p>
<h4 id="Bundling-helpers-1"><a href="#Bundling-helpers-1" class="headerlink" title="Bundling helpers!"></a>Bundling helpers!</h4><p>Install <code>@babel/runtime-corejs3</code> as a development dependency:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D @babel/runtime-corejs3</span><br></pre></td></tr></table></figure>
<h3 id="Problem-3-Externals"><a href="#Problem-3-Externals" class="headerlink" title="Problem 3: Externals"></a>Problem 3: Externals</h3><p>The next thing we will cover is dependencies that we really don’t want to have in our bundle but instead should be provided by the using environment. The next error Webpack throws is about the <code>&#39;react&#39;</code> dependency. To solve this we make use of the <code>externals</code> key:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  externals: &#123;</span><br><span class="line">    react: &#123;</span><br><span class="line">      root: <span class="string">'React'</span>,</span><br><span class="line">      commonjs: <span class="string">'react'</span>,</span><br><span class="line">      commonjs2: <span class="string">'react'</span>,</span><br><span class="line">      amd: <span class="string">'react'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Because some libraries expose themselves differently depending on the module system that is being used, we can (and must) declare the name under which the external can be found for each of these systems. <code>root</code> denotes the name of a global accessible variable. Deeper explanation can be found in the <a href="https://webpack.js.org/configuration/externals/#object">Webpack docs</a>. </p>
<h3 id="Problem-4-TypeScript-file-extensions"><a href="#Problem-4-TypeScript-file-extensions" class="headerlink" title="Problem 4: TypeScript file extensions"></a>Problem 4: TypeScript file extensions</h3><p>This is of course only an issue if you are writing TypeScript. Do you remember when we had to tell the Babel CLI which file extensions it should accept? If not, read again <a href="http://tobias-barth.net/blog/2019/07/Building-your-library-Part-1/">about building our library</a>. Now, Webpack has to find all the files we are trying to import in our code. And like Babel by default it looks for files with <code>.js</code> extension. If we want Webpack to find other files as well we have to give it a list of valid extensions:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">'.tsx'</span>, <span class="string">'.ts'</span>, <span class="string">'.jsx'</span>, <span class="string">'js'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h3><p>Now when we run <code>npx webpack</code> our bundle is made without errors and put into <code>/dist</code>. But there is still a warning from Webpack about the fact that we didn’t set the <code>mode</code> option in our config. The mode can be <code>&#39;development&#39;</code> or <code>&#39;production&#39;</code> and will default to the latter. (There is also the value <code>&#39;none&#39;</code> but we will not cover it here.) It’s kind of a shorthand for several settings and activation of plugins. <code>&#39;development&#39;</code> will keep the output readable (besides other things) while <code>&#39;production&#39;</code> will compress the code as much as possible.</p>
<p>Since we mainly bundle for users to be able to use it in script tags, i.e. additionally to providing single module files, we will not bother to differentiate between the two modes. We only use <code>&#39;production&#39;</code>:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">'production'</span>,</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And thus the warning is gone.</p>
<h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p>Everything is fine now. Or, is it?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node repl</span></span><br><span class="line"></span><br><span class="line">&gt; const lib = require(<span class="string">'./dist/library-starter'</span>)</span><br><span class="line">&gt; lib</span><br><span class="line">&#123;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
<p>We get only an empty module. That is because Webpack by default creates application bundles that should get executed. If we want to get a module with exports than we have to explicitly tell it:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  output: &#123;</span><br><span class="line">    ...</span><br><span class="line">    library: <span class="string">'libraryStarter'</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>But this is still not enough because we now get an executable script that creates a global variable named <code>libraryStarter</code> which contains our library. Actually, this would be enough to drop it into a <code>&lt;script&gt;</code> tag. We could use it on a web page like this:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/library-starter.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">libraryStarter.usePropsThatChanged...</span><br><span class="line">...</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>But come on, we wanted a real UMD module. If we do this, we do it right. So back in our <code>webpack.config.js</code> we add two more options:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"></span><br><span class="line">output: &#123;</span><br><span class="line">  ...</span><br><span class="line">  library: <span class="string">'libraryStarter'</span>,</span><br><span class="line">  libraryTarget: <span class="string">'umd'</span>,</span><br><span class="line">  globalObject: <span class="string">'this'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Let’s run <code>npx webpack</code> again and try it out:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># node repl</span></span><br><span class="line"></span><br><span class="line">&gt; const lib = require(<span class="string">'./dist/library-starter.js'</span>)</span><br><span class="line">&gt; lib</span><br><span class="line">Object [Module] &#123;</span><br><span class="line">   ExampleComponent: [Getter],</span><br><span class="line">   usePropsThatChanged: [Getter]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally. If you wonder, why we added the <code>globalObject</code> key: It makes sure that in the case of using the bundle file without a module system like AMD or CommonJS it works in the browser as well as in a Node context. The return value of the entry point will get assigned to the current <code>this</code> object which is <code>window</code> in browsers and the global object in Node.</p>
<p>There are more nuanced ways to set <code>libraryTarget</code> than explained here. If you are interested please read the <a href="https://webpack.js.org/configuration/output/#outputlibrarytarget">documentation</a>. But for our purposes this should set a solid base.</p>
<h3 id="Build-and-expose"><a href="#Build-and-expose" class="headerlink" title="Build and expose"></a>Build and expose</h3><p>We are done with the configuration part. (Unbelievable, right?!) The only thing that’s left is changing the <code>package.json</code> so that the bundle can be imported from outside as an addition to our ES modules and that users can get it automatically from <a href="https://unpkg.com/">unpkg.com</a> as well.</p>
<p>Right now both, the <code>main</code> and the <code>module</code> key are pointing to <code>dist/index.js</code>. While only the latter is correct. As <a href="http://tobias-barth.net/blog/2019/07/Building-your-library-Part-1/">I mentioned before</a> <code>main</code> should point to a ES5-compatible file and not to an ES module. Now we can safely change it to our new bundle file.</p>
<p>Of course we also have to actually build the bundle. For this we add an npm script named “bundle” to our script section and add it to the “build” script.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "main": "dist/library-starter.js",</span><br><span class="line">  "module": "dist/index.js",</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    ...</span><br><span class="line">    "bundle": "webpack",</span><br><span class="line">    "build": "&lt;our build commands up until now&gt; &amp;&amp; npm run bundle"</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title=" Conclusion"></a><a name="bylww-conclusion"></a> Conclusion</h3><p>Install webpack:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D webpack webpack-cli</span><br></pre></td></tr></table></figure>
<p> Install babel-loader or ts-loader:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D babel-loader <span class="comment"># or ts-loader</span></span><br></pre></td></tr></table></figure>
<p>If using Babel, install its runtime helpers:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -D @babel/runtime-corejs3</span><br></pre></td></tr></table></figure>
<p>Create a <code>webpack.config.js</code>:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mode: <span class="string">"production"</span>,</span><br><span class="line">  entry: <span class="string">"./src/index.js"</span>, <span class="comment">// or './src/index.ts' if TypeScript</span></span><br><span class="line">  output: &#123;</span><br><span class="line">    filename: <span class="string">"library-starter.js"</span>, <span class="comment">// Desired file name. Same as in package.json's "main" field.</span></span><br><span class="line">    path: path.resolve(__dirname, <span class="string">"dist"</span>),</span><br><span class="line">    library: <span class="string">"libraryStarter"</span>, <span class="comment">// Desired name for the global variable when using as a drop-in script-tag.</span></span><br><span class="line">    libraryTarget: <span class="string">"umd"</span>,</span><br><span class="line">    globalObject: <span class="string">"this"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.jsx?/</span>, <span class="comment">// If you are using TypeScript: /\.tsx?$/</span></span><br><span class="line">        include: path.resolve(__dirname, <span class="string">"src"</span>),</span><br><span class="line">        use: [</span><br><span class="line">          <span class="comment">// If using babel-loader</span></span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">"babel-loader"</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              cacheDirectory: <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// If _instead_ using ts-loader</span></span><br><span class="line">          &#123;</span><br><span class="line">          loader: <span class="string">'ts-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            transpileOnly: <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// If using TypeScript</span></span><br><span class="line">  resolve: &#123;</span><br><span class="line">    extensions: [<span class="string">'.tsx'</span>, <span class="string">'.ts'</span>, <span class="string">'.jsx'</span>, <span class="string">'js'</span>]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// If using an external dependency that should not get bundled, e.g. React</span></span><br><span class="line">  externals: &#123;</span><br><span class="line">    react: &#123;</span><br><span class="line">      root: <span class="string">"React"</span>,</span><br><span class="line">      commonjs2: <span class="string">"react"</span>,</span><br><span class="line">      commonjs: <span class="string">"react"</span>,</span><br><span class="line">      amd: <span class="string">"react"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Change the <code>package.json</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">  "main": "dist/library-starter.js",</span><br><span class="line">  "module": "dist/index.js",</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    ...</span><br><span class="line">    "bundle": "webpack",</span><br><span class="line">    "build": "&lt;our build commands up until now&gt; &amp;&amp; npm run bundle"</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That’s all there is to bundling libraries with Webpack.<br>Next article’s topic: Rollup.</p>

	</div>
</article>

	
		<article id="How-to-bundle-your-library-and-why" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/11/How-to-bundle-your-library-and-why/">
	
		<h2 class="blog-post-title">How to bundle your library and why</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-11-18T20:58:14.000Z">18. November 2019</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h3><p>This article is part 6 of the series “Publish a modern JavaScript (or TypeScript) library”. Check out the motivation and links to other parts <a href="http://tobias-barth.net/blog/2019/07/Publish-a-modern-JavaScript-or-TypeScript-library/">in the introduction</a>.</p>
<h3 id="Publishing-formats-–-do-you-even-need-a-bundle"><a href="#Publishing-formats-–-do-you-even-need-a-bundle" class="headerlink" title="Publishing formats – do you even need a bundle?"></a>Publishing formats – do you even need a bundle?</h3><p>At this point in our setup we deliver our library as separate modules. ES Modules to be exact. Let’s discuss what we achieve with that and what could be missing.</p>
<p>Remember, we are publishing a library to be used within other applications. Depending on your concrete use case the library will be used in web applications in browsers or in Node.js applications on servers or locally.</p>
<h4 id="Web-applications-I"><a href="#Web-applications-I" class="headerlink" title="Web applications (I)"></a>Web applications (I)</h4><p>In the case of web applications we can assume that they will get bundled with any of the current solutions, Webpack for example. These bundlers can understand ES Module syntax and since we deliver our code in several modules, the bundler can optimize which code needs to be included and which code doesn’t (tree-shaking). In other words, for this use case we already have everything we need. In fact, bundling our modules together into one blob could defeat our goal to enable end-users to end up with only the code they need. The final application bundlers could maybe no longer differentiate which parts of the library code are being used.</p>
<p><strong>Conclusion: No bundle needed.</strong></p>
<h4 id="Node-js-applications"><a href="#Node-js-applications" class="headerlink" title="Node.js applications"></a>Node.js applications</h4><p>What about Node.js? Typically, Node.js applications consist of several independent files; source files and their dependencies (<code>node_modules</code>). The modules will get imported during runtime when they are needed. But does it work with ES Modules? Sort of.</p>
<p>Node.js v12 has <a href="https://nodejs.org/dist/latest-v12.x/docs/api/esm.html">experimental support for ES Modules</a>. “Experimental” means we must “expect major changes in the implementation including interoperability support, specifier resolution, and default behavior.” But yes, it works and it will work even better and smoother in future versions.</p>
<p>Since Node.js has to support CommonJS modules for the time being and since the two module types are not 100% compatible, there are a few things we have to respect if we want to support both ways of usage. First of all, things <strong>will</strong> change. The Node.js team even <a href="https://medium.com/@Node.js/announcing-a-new-experimental-modules-1be8d2d6c2ff">warns</a> to “publish any ES module packages intended for use by Node.js until [handling of packages that support CJS and ESM] is resolved.”</p>
<blockquote>
<p>That means, if your library is intended <em>only</em> for Node.js (so no browser optimization necessary), you don’t want to rely on your library’s users reading your installation notes (they will have to know <em>what</em> to import/require) or you are not interested in investing in features that are only <em>almost</em> there: Please just don’t publish ES Modules. Change the <a href="https://dev.to/4nduril/transpile-modern-language-features-with-babel-4fcp">configuration</a> of Babel’s <code>env</code> preset to <code>{ modules: &#39;commonjs&#39; }</code> and ship only CommonJS modules.</p>
</blockquote>
<p>But with a bit of work we can make sure everthing will be fine. For now the ESM support is behind a flag (<code>--experimental-modules</code>). When the implementation changes, I will update this post as soon as possible.</p>
<p>Node.js uses a combination of declaring a module <code>type</code> inside of <code>package.json</code> and filename extensions. I won’t lay out every detail and combination of these variants but rather show the (in my opinion) most future-proof and easiest approach.</p>
<p>Right now we have created <code>.js</code> files that are in ES Module syntax. Therefore, we will add the <code>type</code> key to our <code>package.json</code> and set it to <code>&quot;module&quot;</code>. This is the signal to Node.js (if run with the <code>--experimental-modules</code> command line flag) that it should parse every <code>.js</code> file in this package scope as ES Module:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="string">"type"</span>: <span class="string">"module"</span>,</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Note that you oftentimes will come across the advice to use <code>*.mjs</code> file extensions. Don’t do that. <code>*.js</code> is <em>the</em> extension for JavaScript files and will probably always be. Let’s use the default naming for the current standards like ESM syntax. If you have for whatever reason files inside your package that must use CommonJS syntax, give <em>them</em> another extension: <code>*.cjs</code>. Node.js will know what to do with it.</p>
<p>There are a few caveats:</p>
<ol>
<li>Using third party dependencies<ol>
<li>If the external module is (only) in CommonJS syntax, you can import it only as default import. Node.js says that will hopefully change in the future but for now you can’t have named imports on a CommonJS module.</li>
<li>If the external module is published in ESM syntax, check if it follows Node.js’ rules: If there is ESM syntax in a <code>*.js</code> file <strong>and</strong> there is no <code>&quot;type&quot;: &quot;module&quot;</code> in the <code>package.json</code>, the package is broken and you can not use it with ES Modules. (Example: <a href="https://github.com/reactjs/react-lifecycles-compat">react-lifecycles-compat</a>). Webpack would make it work but not Node.js. An example for a properly configured package is <a href="https://github.com/graphql/graphql-js">graphql-js</a>. It uses the <code>*.mjs</code> extension for ESM files.</li>
</ol>
</li>
<li>Imports need file extensions. You can import from a package name (<code>import _ from &#39;lodash&#39;</code>) like before but you can not import from a file (or a folder containing an <code>index.(m)js</code>) without the <em>complete</em> path: <code>import x from &#39;./otherfile.js&#39;</code> will work but <code>import x from &#39;./otherfile&#39;</code> won’t. <code>import y from &#39;./that-folder/index.js&#39;</code> will work but <code>import y from &#39;./that-folder&#39;</code> won’t.</li>
<li>There is a way around the file extension rule but you have to force your users to do it: They must run their program with a second flag: <code>--es-module-specifier-resolution=node</code>. That will restore the resolution pattern Node.js users know from CommonJS. <strong>Unfortunately that is also necessary if you have Babel runtime helpers included by Babel.</strong> Babel will inject default imports which is good, but it omits the file extensions. So if your library depends on Babel transforms, you have to tell your users that they will have to use the second flag. (Not too bad because they already know how to pass ESM related flags when they want to opt into ESM.)</li>
</ol>
<p>For all other users that are not so into experimental features we also publish in CommonJS. To support CommonJS we do something, let’s say, non-canonical in the Node.js world: we deliver a single-file bundle. Normally, people don’t bundle for Node.js because it’s not necessary. But because we need a second compile one way or the other, it’s the easiest path. Also note that other than in the web we don’t have to care too much for size as everything executes locally and is installed beforehand.</p>
<p><strong>Conclusion: Bundle needed if we want to ship both, CommonJS and ESM.</strong></p>
<h4 id="Web-applications-II"><a href="#Web-applications-II" class="headerlink" title="Web applications (II)"></a>Web applications (II)</h4><p>There is another use case regarding web applications. Sometimes people want to be able to include a library by dropping a <code>&lt;script&gt;</code> tag into their HTML and refer to the library via a global variable. (There are also other scenarios that may need such a kind of package.) To make that possible without additional setup by the user, all of your library’s code must be bundled together in one file.</p>
<p><strong>Conclusion: Bundle needed to make usage as easy as possible.</strong></p>
<h4 id="Special-“imports”"><a href="#Special-“imports”" class="headerlink" title="Special “imports”"></a>Special “imports”</h4><p>There is a class of use cases that came up mainly with the rise of Webpack and its rich “loader” landscape. And that is: importing every file type that you can imagine <em>into your JavaScript</em>. It probably started with requiring accompanying CSS files into JS components and went over images and what not. <strong>If you do something like that in your library, you have to use a bundler.</strong> Because otherwise the consumers of your library would have to use a bundler themselves that is at least configured exactly in a way that handles all strange (read: not JS-) imports in your library. Nobody wants to do that.</p>
<p>If you deliver stylings alongside with your JS code, you should do it with a separate CSS file that comes with the rest of the code. And if you write a whole UI library like Bootstrap then you probably don’t want to ask your users for importing hundreds of CSS files but one compiled file. And the same goes for other non-JS file types.</p>
<p><strong>Conclusion: Bundle needed</strong></p>
<h3 id="Ok-ok-now-tell-me-how-to-do-it"><a href="#Ok-ok-now-tell-me-how-to-do-it" class="headerlink" title="Ok, ok, now tell me how to do it!"></a>Ok, ok, now tell me how to do it!</h3><p>Alright. Now you can decide if you really need to bundle your library. Also, you have an idea of what the bundle should “look” like from outside: For classic usage with Node.js, it should be a big CommonJS module, consumable with <code>require()</code>. For further bundling in web applications it may be better to have a big ES module that is tree-shakable.</p>
<p>And here is the cliffhanger: Each of the common bundling tools will get their own article in this series. This post is already long enough.</p>
<p>Next up: Use Webpack for bundling your library.</p>

	</div>
</article>

	

</div>

		</main>
	<footer class="site-footer h-card" aria-describedby="dse">
		<h3 class="in-site-footer cta">Kontaktieren Sie mich</h3>
		<p class="in-site-footer">Email: <a href="mailto:contact@tobias-barth.net" rel="me" class="u-email">contact@tobias-barth.net</a><br />
		Telefon: <a href="tel:+4915111215929">+49 151 112 15 929</a></p>
		<p id="dse" class="in-site-footer">(Bitte beachten Sie vor der Kontaktaufnahme meine Datenschutzerklärung.)</p>
		<h3 class="in-site-footer cta">Finden Sie mich</h3>
		<p class="in-site-footer"><img class="sm u-photo" src="/images/Portrait.png" alt="Mein Avatar" /><a class="sm fa fa-adn" href="https://alpha.app.net/4nduril" rel="me"><span>App.net</span></a> <a class="sm fa fa-twitter" href="https://twitter.com/4nduril" rel="me"><span>Twitter</span></a> <a class="sm fa fa-github-square" href="https://github.com/4nduril" rel="me"><span>Github</span></a></p>
		<h3 class="in-site-footer">Impressum</h3>
		<p class="in-site-footer">Inhaltlich verantwortlich gemäß § 5 <abbr title="Telemediengesetz">TMG</abbr>:<br />
		<a href="http://tobias-barth.net" class="p-name u-url">Tobias&nbsp;Barth</a><br />
		<span class="p-street-address">Vincenzstr.&nbsp;25</span><br />
		<span class="p-locality p-postal-code">51065&nbsp;Köln</span></p>
		<p class="in-site-footer">USt-ID: DE304359556</p>
		<h4 class="in-site-footer">Fotos</h4>
		<p class="in-site-footer">&copy;&nbsp;<a href="http://annebarth.de">Anne&nbsp;Barth</a></p>
		<p class="in-site-footer"><a href="dse.html">Datenschutzerklärung</a></p>
	</footer>
</body>

</html>
