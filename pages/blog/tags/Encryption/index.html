<!DOCTYPE html>
<html lang="de">
<head><meta name="generator" content="Hexo 3.9.0">
	<meta charset="utf-8">
	<title>tobias-barth.net | Moderne Webentwicklung aus Köln</title>
	<meta name="description" content>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="/css/style.css">
	<!--[if lt IE 9]>
		<link rel="stylesheet" href="/css/old-ie.css" />
	<![endif]-->

	<link rel="alternate" type="application/rss+xml" href="/blog/feed/rss.xml">

</head>
<body>
	<header class="site-head">
			<a href="/"><h1 class="in-site-head">tobias-barth.net</h1>
			<p class="tagline in-site-head">Moderne Webentwicklung aus Köln</p></a>
		</header>

</body></html>
		<main>
			<nav class="main-navi" id="main-navi">
				<ul>
					<li><a href="/portfolio" title="Meine Fähigkeiten, Arbeitsfelder und Beispielprojekte"><span class="fa fa-wrench"></span> Ich mache</a></li>
				<li><a href="/blog" title="Mein Blog über Webentwicklung und Ähnliches"><span class="fa fa-pencil"></span> Ich schreibe</a></li>
<!--					<li><a href="" title="Lernen Sie mich besser kennen"><span class="fa fa-user"></span> Ich bin</a></li>-->
				</ul>
			</nav>
		<div class="blog-textcontainer">

	
		<article id="Resize-LVM-on-LUKS-partition-without-messing-everything-up" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/06/Resize-LVM-on-LUKS-partition-without-messing-everything-up/">
	
		<h2 class="blog-post-title">Resize LVM on LUKS partition without messing everything up</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-06-10T11:49:27.000Z">10. Juni 2019</time></p>
	</header>
	<div class="blog-post-content">
		<p>Since forever I run my work computer operating systems on a full-disk-encrypted partition. Currently this is Manjaro Linux. When I set up my current machine I made the following partition scheme:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sda                  <span class="number">238</span>,<span class="number">5</span>G  disk</span><br><span class="line">├─sda1                 <span class="number">260</span>M  part  /boot/efi</span><br><span class="line">├─sda2                 <span class="number">128</span>M  part  /boot</span><br><span class="line">└─sda3                 <span class="number">237</span>G  part</span><br><span class="line">  └─tank               <span class="number">237</span>G  crypt</span><br></pre></td></tr></table></figure>
<p>Somewhere, I can’t even remember when, I read that 128M for <code>/boot</code> would be sufficient. And it was for a few years. But kernel images and/or initram disks grew bigger and bigger until I could not upgrade to a newer kernel anymore. The last kernel I ran was Linux 4.16 and the files in <code>/boot</code> took around 75M space and so <code>mhwd-kernel -i linux417</code> had too little space on the device left.</p>
<p>What I needed to do was to shrink <code>/dev/sda3</code>, move it to the end of the SSD and grow <code>/dev/sda2</code> as necessary.</p>
<p>But I did not know if this was even possible with my setup. Inside the encrypted partition there is an LVM container with 5 logical volumes including <code>/</code>. I pushed it into the future again and again because most of the time I am working in running projects and can not afford to have a non-functioning machine for \<absurd amount of time that you never expect before a hardware near change\>.</p>
<p>But in the end it was relatively easy. I had feared that in the worst case I would have to re-setup my whole machine and restore backups for the data and system partitions. Which then maybe would need endless tweaking until it runs again (No, I never had a hard disk failure or similar, so I never had to actually do anything like that).</p>
<p>So, here are the things I needed to do:</p>
<h2 id="1-Backup"><a href="#1-Backup" class="headerlink" title="1. Backup"></a>1. Backup</h2><p>List all logcal volumes:<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lvs</span></span><br><span class="line">LV     VG   Attr       LSize  <span class="built_in"> Pool </span>Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">docker tank -wi-ao----   5,00g                                        </span><br><span class="line">home   tank -wi-ao---- 100,00g                                        </span><br><span class="line">mongo  tank -wi-ao----   1,00g                                        </span><br><span class="line">root   tank -wi-ao----  25,00g                                        </span><br><span class="line">swap   tank -wc-ao----  32,00g</span><br></pre></td></tr></table></figure></p>
<p>For each lv do the following:<br><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># lvcreate -s -n &lt;<span class="keyword">name</span>&gt;snap /dev/tank/&lt;<span class="keyword">name</span>&gt;</span><br><span class="line"># dd <span class="keyword">if</span>=/dev/tank/&lt;<span class="keyword">name</span>&gt;snap <span class="keyword">of</span>=/path/<span class="keyword">to</span>/<span class="keyword">external</span>/storage/&lt;<span class="keyword">name</span>&gt;.img</span><br></pre></td></tr></table></figure></p>
<p>Where <code>&lt;name&gt;</code> must be replaced by the actual names of the lvs. Then I backed up both the <code>/boot</code> and the <code>/boot/efi</code> partitions, also with <code>dd</code>.<br>Finally I made a backup of the LUKS header for the crypto-partition:<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cryptsetup luksHeaderBackup <span class="regexp">/dev/</span>sda3 --header-backup-<span class="keyword">file</span> <span class="regexp">/path/</span>to<span class="regexp">/external/</span>storage<span class="regexp">/luks-header.bkp</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2-Boot-in-a-live-system-from-an-USB-stick-and-decrypt-the-device"><a href="#2-Boot-in-a-live-system-from-an-USB-stick-and-decrypt-the-device" class="headerlink" title="2. Boot in a live system from an USB stick and decrypt the device"></a>2. Boot in a live system from an USB stick and decrypt the device</h2><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cryptsetup <span class="keyword">open</span> /dev/sda3 tank --<span class="class"><span class="keyword">type</span> <span class="title">luks</span></span></span><br></pre></td></tr></table></figure>
<h2 id="3-Resize-the-physical-volume"><a href="#3-Resize-the-physical-volume" class="headerlink" title="3. Resize the physical volume"></a>3. Resize the physical volume</h2><p><strong>Note:</strong> I have free space inside my LVM container. As you can see from the output of <code>lvs</code> above I currently use only 143GB out of roughly 238GB. That means I do not have to resize logical volumes <em>before</em> I resize the containing physical volume. If you use all of the available space for logical volumes, look into <a href="https://jlk.fjfi.cvut.cz/arch/manpages/man/lvresize.8"><code>lvresize(8)</code></a> first: For example in the  <a href="https://wiki.archlinux.org/index.php/LVM#Resizing_volumes">Arch Wiki</a>.</p>
<p>I generously shrank the volume from 238,07G to 236G with:<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># pvresize --setphysicalvolumesize 236G /dev/mapper/tank</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4-Resize-the-crypto-device"><a href="#4-Resize-the-crypto-device" class="headerlink" title="4. Resize the crypto-device"></a>4. Resize the crypto-device</h2><p>Find out how many sectors is the current size (note that my crypto-device has the same name like my volume group: <code>tank</code>. That could be different in your setup):<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cryptsetup status tank</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">sector size:</span>  <span class="number">512</span></span><br><span class="line"><span class="attr">size:</span>  <span class="number">499122176</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure></p>
<p>In the end I want to add about 1G to the <code>/boot</code> partition. That is <code>1024 * 1024 * 1024 / 512 = 2097152</code> sectors.<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cryptsetup -b 497025024 resize tank</span></span><br></pre></td></tr></table></figure></p>
<h2 id="5-Resize-the-GUID-partition"><a href="#5-Resize-the-GUID-partition" class="headerlink" title="5. Resize the GUID partition"></a>5. Resize the GUID partition</h2><p>You see we go from innermost to outermost: LVM -&gt; crypto -&gt; GUID. I use <code>parted</code> to resize the partition <code>/dev/sda3</code>:<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># parted</span><br><span class="line">(parted) <span class="keyword">unit</span> s</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">Number</span>  Begin     <span class="keyword">End</span>         <span class="built_in">Size</span>                     <span class="keyword">Name</span>  Flags</span><br><span class="line">...</span><br><span class="line"><span class="number">3</span>      <span class="number">3</span>100672s  <span class="number">5</span>00115455s  <span class="number">4</span>97014784s               TANK  lvm</span><br></pre></td></tr></table></figure></p>
<p>These numbers were actually different as I write this blog post in hindsight. The point is that partition number 3 went all the way to the last sector of the disk and I now must calculate where it should end in the future. Because <code>resizepart</code> takes not the future size but the future end sector of the partition as argument. So I subtract the same sector count as calculated above for cryptsetup (<code>2097152</code>) from the <em>end sector</em> of partition 3 (<code>500115455</code>) which gives <code>498018303</code>.<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="name">parted</span>) resizepart <span class="number">3</span> <span class="number">498018303</span>s</span><br></pre></td></tr></table></figure></p>
<p>Now we have free space on the SSD <em>after</em> the main partition. But I want to grow partition 2.</p>
<h2 id="6-Reorder-partitions-and-resize-partition-2"><a href="#6-Reorder-partitions-and-resize-partition-2" class="headerlink" title="6. Reorder partitions and resize partition 2"></a>6. Reorder partitions and resize partition 2</h2><p>I did that with GParted instead of a command line tool. Probably there is a way to do it with <code>gdisk</code> but <code>parted</code> has removed its command to <code>move</code> partitions. And because I was in a graphical live system anyway and also read that you could do it with GParted I just went for it.<br>First I closed the crypto device because GParted would not let me move the partition otherwise:<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># vgchange -an tank</span></span><br><span class="line"><span class="meta"># cryptsetup close tank</span></span><br></pre></td></tr></table></figure></p>
<p>Then I opened GParted and right-clicked on the crypto partition. I chose “Change size|Move” and moved the free space after the partition before it. Then I opend the same dialog for the <code>/boot</code> partition and extended it to cover all of the free space. Finally I committed the changes.</p>

	</div>
</article>

	

</div>

		</main>
	<footer class="site-footer h-card" aria-describedby="dse">
		<h3 class="in-site-footer cta">Kontaktieren Sie mich</h3>
		<p class="in-site-footer">Email: <a href="mailto:contact@tobias-barth.net" rel="me" class="u-email">contact@tobias-barth.net</a><br />
		Telefon: <a href="tel:+4915111215929">+49 151 112 15 929</a></p>
		<p id="dse" class="in-site-footer">(Bitte beachten Sie vor der Kontaktaufnahme meine Datenschutzerklärung.)</p>
		<h3 class="in-site-footer cta">Finden Sie mich</h3>
		<p class="in-site-footer"><img class="sm u-photo" src="/images/Portrait.png" alt="Mein Avatar" /><a class="sm fa fa-adn" href="https://alpha.app.net/4nduril" rel="me"><span>App.net</span></a> <a class="sm fa fa-twitter" href="https://twitter.com/4nduril" rel="me"><span>Twitter</span></a> <a class="sm fa fa-github-square" href="https://github.com/4nduril" rel="me"><span>Github</span></a></p>
		<h3 class="in-site-footer">Impressum</h3>
		<p class="in-site-footer">Inhaltlich verantwortlich gemäß § 5 <abbr title="Telemediengesetz">TMG</abbr>:<br />
		<a href="http://tobias-barth.net" class="p-name u-url">Tobias&nbsp;Barth</a><br />
		<span class="p-street-address">Vincenzstr.&nbsp;25</span><br />
		<span class="p-locality p-postal-code">51065&nbsp;Köln</span></p>
		<p class="in-site-footer">USt-ID: DE304359556</p>
		<h4 class="in-site-footer">Fotos</h4>
		<p class="in-site-footer">&copy;&nbsp;<a href="http://annebarth.de">Anne&nbsp;Barth</a></p>
		<p class="in-site-footer"><a href="dse.html">Datenschutzerklärung</a></p>
	</footer>
</body>

</html>
