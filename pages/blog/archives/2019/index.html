<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="utf-8" />
	<title>tobias-barth.net | Moderne Webentwicklung aus Köln</title>
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/css/style.css" />
	<!--[if lt IE 9]>
		<link rel="stylesheet" href="/css/old-ie.css" />
	<![endif]-->

	<link rel="alternate" type="application/rss+xml" href="/blog/feed/rss.xml" />

</head>
<body>
	<header class="site-head">
			<a href="/"><h1 class="in-site-head">tobias-barth.net</h1>
			<p class="tagline in-site-head">Moderne Webentwicklung aus Köln</p></a>
		</header>


		<main>
			<nav class="main-navi" id="main-navi">
				<ul>
					<li><a href="/portfolio" title="Meine Fähigkeiten, Arbeitsfelder und Beispielprojekte"><span class="fa fa-wrench"></span> Ich mache</a></li>
				<li><a href="/blog" title="Mein Blog über Webentwicklung und Ähnliches"><span class="fa fa-pencil"></span> Ich schreibe</a></li>
<!--					<li><a href="" title="Lernen Sie mich besser kennen"><span class="fa fa-user"></span> Ich bin</a></li>-->
				</ul>
			</nav>
		<div class="blog-textcontainer">

	
		<article id="Compiling-modern-language-features-with-the-TypeScript-compiler" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/07/Compiling-modern-language-features-with-the-TypeScript-compiler/">
	
		<h2 class="blog-post-title">Compiling modern language features with the TypeScript compiler</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-07-18T11:24:59.000Z">18. Juli 2019</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h3><p>This article is part 2 of the series “Publish a modern JavaScript (or TypeScript) library”. Check out the motivation and links to other parts <a href="http://tobias-barth.net/blog/2019/07/Publish-a-modern-JavaScript-or-TypeScript-library/">in the introduction</a>.</p>
<h3 id="How-to-use-the-TypeScript-compiler-tsc-to-transpile-your-code"><a href="#How-to-use-the-TypeScript-compiler-tsc-to-transpile-your-code" class="headerlink" title="How to use the TypeScript compiler tsc to transpile your code"></a>How to use the TypeScript compiler <code>tsc</code> to transpile your code</h3><p><strong>If you are not interested in the background and reasoning behind the setup, <a href="#cmlfwttc-conclusion">jump directly to the conclusion</a></strong></p>
<p>In the last article we set up Babel to transpile modern JavaScript or even TypeScript to a form which is understood by our target browsers. But we can also instead use the TypeScript compiler <code>tsc</code> to do that. For illustrating purposes I have rewritten my small <a href="https://github.com/4nduril/library-starter/tree/rewrite-in-typescript">example library</a> in TypeScript. Be sure to look at one of the <code>typescript-</code> prefixed branches. The <code>master</code> is still written in JavaScript.</p>
<p>I will assume that you already know how to setup a TypeScript project. How else would you have been able to write your library in TS? Rather, I will focus only on the best configuration possible for transpiling for the purposes of delivering a library.</p>
<p>You already know, the configuration is done via a <code>tsconfig.json</code> in the root of your project. It should contain the following options that I will discuss further below:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"include"</span>: [<span class="string">"./src/**/*"</span>],</span><br><span class="line">  <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="string">"outDir"</span>: <span class="string">"./dist"</span>,</span><br><span class="line">    <span class="string">"target"</span>: <span class="string">"es2017"</span>,</span><br><span class="line">    <span class="string">"module"</span>: <span class="string">"esnext"</span>,</span><br><span class="line">    <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>,</span><br><span class="line">    <span class="string">"importHelpers"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="include-and-outDir"><a href="#include-and-outDir" class="headerlink" title="include and outDir"></a><code>include</code> and <code>outDir</code></h3><p>These options tell <code>tsc</code> where to find the files to compile and where to put the result. When we discuss how to emit type declaration files along with your code, <code>outDir</code> will be used also for their destination. </p>
<p>Note that these options allow us to just run <code>tsc</code> on the command line without anything else and it will find our files and put the output where it belongs.</p>
<h3 id="Target-environment"><a href="#Target-environment" class="headerlink" title="Target environment"></a>Target environment</h3><p>Remember when we discussed <code>browserslist</code> in the “Babel” article? (If not, <a href="http://tobias-barth.net/blog/2019/07/Transpile-modern-language-features-with-Babel/">check it out here</a>.) We used an array of queries to tell Babel exactly which environments our code should be able to run in. Not so with <code>tsc</code>.</p>
<p>If you are interested, read this intriguing <a href="https://github.com/Microsoft/TypeScript/issues/19183">issue</a> in the TypeScript GitHub repository. Maybe some day in the future we will have such a feature in <code>tsc</code> but for now, we have to use “JavaScript versions” as targets.</p>
<p>As you may know, since 2015 every year the TC39 committee ratifies a new version of ECMAScript consisting of all the new features that have reached the “Finished” stage before that ratification. (See <a href="https://tc39.es/process-document/">The TC39 process</a>.)</p>
<p>Now <code>tsc</code> allows us (only) to specify which version of ECMAScript we are targeting. To reach a more or less similar result as with Babel and my opinionated <code>browserslist</code> config, I decided to go with <code>es2017</code>. I have used the <a href="https://kangax.github.io/compat-table/es2016plus/">ECMAScript compatibility table</a> and checked until which version it would be “safe” to assume that the last 2 versions of Edge/Chrome/Firefox/Safari/iOS can handle it. Your mileage may vary here! You have basically at least three options:</p>
<ul>
<li>Go with my suggestion and use <code>es2017</code>.</li>
<li>Make your own decision based on the compatibility table.</li>
<li>Go for the safest option and use <code>es5</code>. This will produce code that can also run in Internet Explorer 11 but also will it be much bigger in size — for all browsers.</li>
</ul>
<p>Just like with my <code>browserslist</code> config, I will discuss in a future article how to provide more than one bundle: one for modern environments and one for older ones.</p>
<p>Another thing to note here: The <code>target</code> does not directly set which module syntax should be used in the output! You may think it does, because if you don’t explicitly set <code>module</code> (see next section), <code>tsc</code> will choose it dependent of your <code>target</code> setting. If your <code>target</code> is <code>es3</code> or <code>es5</code>, <code>module</code> will be set implicitly to <code>CommonJS</code>. Otherwise it will be set to <code>es6</code>. To make sure you don’t get surprised by what <code>tsc</code> chooses for you, you should always set <code>module</code> explicitly as described in the following section.</p>
<h3 id="module-and-moduleResolution"><a href="#module-and-moduleResolution" class="headerlink" title="module and moduleResolution"></a><code>module</code> and <code>moduleResolution</code></h3><p>Setting <code>module</code> to <code>&quot;esnext&quot;</code> is roughly the same as the <code>modules: false</code> option of the <code>env</code> preset in our <code>babel.config.js</code>: We make sure that the module syntax of our code stays as ESModules to enable treeshaking.</p>
<p>If we set <code>module: &quot;esnext&quot;</code>, we have to also set <code>moduleResolution</code> to <code>&quot;node&quot;</code>. The TypeScript compiler has two modes for finding non-relative modules (i.e. <code>import {x} from &#39;moduleA&#39;</code> as opposed to <code>import {y} from &#39;./moduleB&#39;</code>): These modes are called <code>node</code> and <code>classic</code>. The former works similar to the resolution mode of NodeJS (hence the name). The latter does not know about <code>node_modules</code> which is strange and almost never what you want. But <code>tsc</code> enables the <code>classic</code> mode when <code>module</code> is set to <code>&quot;esnext&quot;</code> so you have to explicitly tell it to behave.</p>
<p>In the <code>target</code> section above I mentioned that <code>tsc</code> will set <code>module</code> implicitly to <code>es6</code> if <code>target</code> is something other than <code>es3</code> or <code>es5</code>. There is a subtle difference between <code>es6</code> and <code>esnext</code>. According to the answers in <a href="https://github.com/Microsoft/TypeScript/issues/24082">this GitHub issue</a> <code>esnext</code> is meant for all the features that are “on the standard track but not in an official ES spec” (yet). That includes features like dynamic import syntax (<code>import()</code>) which is definitely something you should be able to use because it enables code splitting with Webpack. (Maybe a bit more important for applications than for libraries, but just that you know.)</p>
<h3 id="importHelpers"><a href="#importHelpers" class="headerlink" title="importHelpers"></a><code>importHelpers</code></h3><p>You can compare <code>importHelpers</code> to Babel’s <code>transform-runtime</code> plugin: Instead of inlining the same helper functions over and over again and making your library bigger and bigger, <code>tsc</code> now injects imports to <code>tslib</code> which contains all these helpers just like <code>@babel/runtime</code>. But this time we will install the production dependency and not leave it to our users:</p>
<p><code>npm i tslib</code></p>
<p>The reason for that is that <code>tsc</code> will not compile without it. <code>importHelpers</code> creates imports in our code and if <code>tsc</code> does not find the module that gets imported it aborts with an error.</p>
<h3 id="Should-you-use-tsc-or-Babel-for-transpiling"><a href="#Should-you-use-tsc-or-Babel-for-transpiling" class="headerlink" title="Should you use tsc or Babel for transpiling?"></a>Should you use <code>tsc</code> or Babel for transpiling?</h3><p>This is a bit opinion-based. But I think that you are better off with Babel then with <code>tsc</code>.</p>
<p>TypeScript is great and can have many benefits (even if I <strong>personally</strong> think JavaScript as a language is more powerful without it and the hassle you get with TypeScript outweighs its benefits). And if you want, you should use it! But let Babel produce the final JavaScript files that you are going to deliver. Babel allows for a better configuration and is highly optimized for exactly this purpose. TypeScript’s aim is to provide type-safety so you should use it (separately) for that. And there is another issue: Polyfills.</p>
<p>With a good Babel setup you get everything you need for running your code in the target environments. Not with <code>tsc</code>! It’s now your task to provide all the polyfills that your code needs. And first, to figure out which these are. Even if you don’t agree with my opinion about the different use-cases of Babel and TypeScript, the polyfill issue alone should be enough to follow me on this.</p>
<p>There is a wonderful blog post about using Babel instead of <code>tsc</code> for transpiling: <a href="https://iamturns.com/typescript-babel/">TypeScript With Babel: A Beautiful Marriage</a>. And it lists also the caveats of using Babel for TS: There are four small things that are possible in TypeScript but are not understood correctly by Babel: Namespaces (Don’t use them. They are outdated.), type casting with angle brackets (Use <code>as</code> syntax instead.), <code>const enum</code> (Use normal enums by omitting <code>const</code>.) and legacy style import/export syntax (It’s <strong>legacy</strong> — let it go). I think the only important constraint here is the <code>const enum</code> because it leads to a little bit more code in the output if you use standard enums. But unless you introduce enums with hundreds and hundreds of members, that problem should be negligible.</p>
<p>Also, it’s way faster to just discard all type annotations than checking the types first. This enables for example a faster compile cycle in development-/watch-mode. The example project that I use for this series is maybe not doing enough to be seen as a good compile time example. But also in another library project of mine which consists of ~25 source files and several third-party dependencies, Babel is five times faster than <code>tsc</code>. That is annoying enough when you are coding and have to wait after every save to see the results.</p>
<h3 id="Conclusion-and-final-notes-for-the-tsc-setup"><a href="#Conclusion-and-final-notes-for-the-tsc-setup" class="headerlink" title="Conclusion and final notes for the tsc setup"></a><a name="cmlfwttc-conclusion"></a>Conclusion and final notes for the <code>tsc</code> setup</h3><p>(If you really want to use <code>tsc</code> for this task (see the last paragraphs above): )</p>
<p>Install <code>tslib</code>:</p>
<p><code>npm i tslib</code></p>
<p>Make sure your <code>tsconfig.json</code> contains at least the following options:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="string">"outDir"</span>: <span class="string">"./dist"</span>, <span class="comment">// where should tsc put the transpiled files</span></span><br><span class="line">    <span class="string">"target"</span>: <span class="string">"es2017"</span>, <span class="comment">// set of features that we assume our targets can handle themselves</span></span><br><span class="line">    <span class="string">"module"</span>: <span class="string">"esnext"</span>, <span class="comment">// emit ESModules to allow treeshaking</span></span><br><span class="line">    <span class="string">"moduleResolution"</span>: <span class="string">"node"</span>, <span class="comment">// necessary with 'module: esnext'</span></span><br><span class="line">    <span class="string">"importHelpers"</span>: <span class="literal">true</span> <span class="comment">// use tslib for helper deduplication</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"include"</span>: [<span class="string">"./src/**/*"</span>] <span class="comment">// which files to compile</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you are sure you want or need to support older browsers like Android/Samsung 4.4 or Internet Explorer 11 with only one configuration, replace the <code>es2017</code> target with <code>es5</code>. In a future article I will discuss how to create and publish more than one package: One as small as possible for more modern targets and one to support older engines with more helper code and therefore bigger size.</p>
<p>And remember: In this article I talked only about using <code>tsc</code> as transpiler. We will of course use it for type-checking, but this is another chapter.</p>
<p>Next up: Type-Checking and providing type declarations</p>

	</div>
</article>

	
		<article id="Transpile-modern-language-features-with-Babel" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/07/Transpile-modern-language-features-with-Babel/">
	
		<h2 class="blog-post-title">Transpile modern language features with Babel</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-07-05T14:05:11.000Z">05. Juli 2019</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h3><p>This article is part 1 of the series “Publish a modern JavaScript (or TypeScript) library”. Check out the motivation and links to other parts <a href="http://tobias-barth.net/blog/2019/07/Publish-a-modern-JavaScript-or-TypeScript-library/">in the introduction</a>.</p>
<h3 id="Why-Babel-and-how-should-you-use-it-in-a-library"><a href="#Why-Babel-and-how-should-you-use-it-in-a-library" class="headerlink" title="Why Babel and how should you use it in a library?"></a>Why Babel and how should you use it in a library?</h3><p><strong>If you are not interested in the background and reasoning behind the setup, <a href="#tmplfwb-conclusion">jump directly to the conclusion</a></strong></p>
<p>Babel can transpile JavaScript as well as TypeScript. I would argue that it’s even better to use Babel instead of the TypeScript compiler for compiling the code (down) to compatible JavaScript because it is faster. What Babel does when it compiles TypeScript is it just discards everything that isn’t JavaScript. <strong>Babel does no type checking.</strong> Which we don’t need at this point.</p>
<p>To use Babel you have to install it first: Run <code>npm install -D @babel/core @babel/cli @babel/preset-env</code>. This will install the core files, the preset you are going to need always and the command line interface so that you can run Babel in your terminal. Additionally, you should install <code>@babel/preset-typescript</code> and/or <code>@babel/preset-react</code>, both according to your needs. I will explain in a bit what each of is used for but you can imagine from their names in which situations you need them.</p>
<p>So, setup time! Babel is configured via a configuration file. (For details and special cases see <a href="https://babeljs.io/docs/en/config-files">the documentation</a>.) The project-wide configuration file should be <code>babel.config.js</code>. It looks at least very similar to this one:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@babel/env'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        modules: <span class="literal">false</span>,</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'@babel/preset-typescript'</span>,</span><br><span class="line">    <span class="string">'@babel/preset-react'</span></span><br><span class="line">  ],</span><br><span class="line">  plugins: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@babel/plugin-transform-runtime'</span>,</span><br><span class="line">      &#123; corejs: <span class="number">3</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">],</span><br><span class="line">  env: &#123;</span><br><span class="line">    test: &#123;</span><br><span class="line">      presets: [<span class="string">'@babel/env'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Let’s go through it because there are a few assumptions used in this config which we will need for other features in our list.</p>
<h3 id="module-exports-…"><a href="#module-exports-…" class="headerlink" title="module.exports = {…}"></a><code>module.exports = {…}</code></h3><p>The file is treated as a CommonJS module and is expected to return a configuration object. It is possible to export a function instead but we’ll stick to the static object here. For the function version look into the <a href="https://babeljs.io/docs/en/config-files#config-function-api">docs</a>.</p>
<h3 id="presets"><a href="#presets" class="headerlink" title="presets"></a><code>presets</code></h3><p>Presets are (sometimes configurable) sets of Babel plugins so that you don’t have to manage yourself which plugins you need. The one you should definitely use is <code>@babel/preset-env</code>. You have already installed it. Under the <code>presets</code> key in the config you list every preset your library is going to use along with any preset configuration options.</p>
<p>In the example config above there are three presets: </p>
<ol>
<li><code>env</code> is the mentioned standard one. </li>
<li><code>typescript</code> is obviously only needed to compile files that contain TypeScript syntax. As already mentioned it works by <strong>throwing away</strong> anything that isn’t JavaScript. It does not interpret or even check TypeScript. <em>And that’s a Good Thing.</em> We will talk about that point later. If your library is not written in TypeScript, you don’t need this preset. But if you need it, you have to install it of course: <code>npm install -D @babel/preset-typescript</code>.</li>
<li><code>react</code> is clearly only needed in React projects. It brings plugins for JSX syntax and transforming. If you need it, install it with: <code>npm i -D @babel/preset-react</code>. Note: With the config option <code>pragma</code> (and probably <code>pragmaFrag</code>) you can transpile JSX to other functions than <code>React.createElement</code>. See <a href="https://babeljs.io/docs/en/babel-preset-react#pragma">documentation</a>.</li>
</ol>
<p>Let us look at the <code>env</code> preset again. Notable is the <code>modules: false</code> option for <code>preset-env</code>. The effect is this: As per default Babel transpiles ESModules (<code>import</code> / <code>export</code>) to CommonJS modules (<code>require()</code> / <code>module.export(s)</code>). With <code>modules</code> set to <code>false</code> Babel will output the transpiled files with their ESModule syntax untouched. The rest of the code will be transformed, just the module related statements stay the same. This has (at least) two benefits:</p>
<p>First, this is a library. If you publish it as separate files, users of your library can import exactly the modules they need. And if they use a bundler that has the ability to treeshake (that is: to remove unused modules on bundling), they will end up with only the code bits they need from your library. With CommonJS modules that would not be possible and they would have your whole library in their bundle.</p>
<p>Furthermore, if you are going to provide your library as a bundle (for example a UMD bundle that one can use via <a href="http://unpkg.com">unpkg.com</a>), you can make use of treeshaking and shrink your bundle as much as possible.</p>
<p>There is another, suspiciously absent option for <code>preset-env</code> and that is the <code>targets</code> option. If you omit it, Babel will transpile your code down to ES5. That is most likely not what you want—unless you live in the dark, medieval times of JavaScript (or you know someone who uses <abbr title="Internet Explorer">IE</abbr>). Why transpiling something (and generating much more code) if the runtime environment can handle your modern code? What you could do is to provide said <code>targets</code> key and give it a <a href="https://github.com/ai/browserslist">Browserslist</a> compatible query (see <a href="https://babeljs.io/docs/en/babel-preset-env#targets">Babel documentation</a>). For example something like <code>&quot;last 2 versions&quot;</code> or even <code>&quot;defaults&quot;</code>. In that case Babel would use the browserslist tool to find out which features it has to transpile to be able to run in the environments given with <code>targets</code>.</p>
<p>But we will use another place to put this configuration than the <code>babel.config.js</code> file. You see, Babel is not the only tool that can make use of browserslist. But any tool, including Babel, will find the configuration if it’s in the right place. The documentation of browserslist recommends to put it inside <code>package.json</code> so we will do that. Add something like the following to your library’s <code>package.json</code>:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">"browserslist": [</span><br><span class="line">  "last 2 Chrome versions",</span><br><span class="line">  "last 2 Firefox versions",</span><br><span class="line">  "last 2 Edge versions",</span><br><span class="line">  "last 2 Opera versions",</span><br><span class="line">  "last 2 FirefoxAndroid versions",</span><br><span class="line">  "last 2 iOS version",</span><br><span class="line">  "last 2 safari version"</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>I will admit this query is a bit opinionated, maybe not even good for you. You can of course roll your own, or if you are unsure, just go with this one:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">"browserslist": "defaults" // alias for "&gt; 0.5%, last 2 versions, Firefox ESR, not dead"; contains ie 11</span><br></pre></td></tr></table></figure>
<p>The reason I propose the query array above is that I want to get an optimized build for modern browsers. <code>&quot;defaults&quot;</code>, <code>&quot;last 2 versions&quot;</code> (without specific browser names) and the like will include things like Internet Explorer 11 and Samsung Internet 4. These ancient browsers do not support so much even of ES2015. We would end up with a much much bigger deliverable than modern browsers would need. But there is something you can do about it. You can deliver modern code to modern browsers and still support The Ancients™. We will go into further details in a future section but as a little cliffhanger: browserslist supports multiple configurations. For now we will target only modern browsers.</p>
<h3 id="plugins"><a href="#plugins" class="headerlink" title="plugins"></a><code>plugins</code></h3><p>The Babel configuration above defines one extra plugin: <code>plugin-transform-runtime</code>. The main reason to use this is deduplication of helper code. When Babel transpiles your modules, it injects little (or not so little) helper functions. The problem is that it does so in every file where they are needed. The <code>transform-runtime</code> plugin replaces all those injected functions with <code>require</code> statements to the <code>@babel/runtime</code> package. That means <strong>in the final application there has to be this runtime package</strong>.</p>
<p>To make that happen you could just add <code>@babel/runtime</code> to the prod dependencies of your library (<code>npm i @babel/runtime</code>). That would definitely work. But here we will add it to the <code>peerDependencies</code> in <code>package.json</code>. That way the user of your library has to install it themselves but on the other hand, they have more control over the version (and you don’t have to update the dependency too often). And maybe they have it installed already anyway. So we just push it out of our way and just make sure that it is there when needed.</p>
<p>Back to the Babel plugin. To use that plugin you have to install it: <code>npm i -D @babel/plugin-transform-runtime</code>. Now you’re good to go.</p>
<p>Before we go on to the <code>env</code> key, this is the right place to talk about polyfills and how to use them with Babel.</p>
<h3 id="How-to-use-polyfills-in-the-best-way-possible"><a href="#How-to-use-polyfills-in-the-best-way-possible" class="headerlink" title="How to use polyfills in the best way possible"></a>How to use polyfills in the best way possible</h3><p>It took me a few hours reading and understanding the problem, the current solutions and their weaknesses. If you want to read it up yourself, start at <a href="https://babeljs.io/docs/en/babel-polyfill">Babel polyfill</a>, go on with <a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime">Babel transform-runtime</a> and then read <a href="https://github.com/zloirock/core-js/blob/master/docs/2019-03-19-core-js-3-babel-and-a-look-into-the-future.md">core-js@3, babel and a look into the future</a>.</p>
<p>But because I already did you don’t have to if you don’t want to. Ok, let’s start with the fact that there two standard ways to get polyfills into your code. Wait, one step back: Why polyfills?</p>
<p>If you already know, skip to <a href="#tmplfwb-import-core-js">Import core-js</a>. When Babel transpiles your code according to the target environment that you specified, it just changes syntax. Code that the target (the browser) does not understand is changed to (probably longer and more complicated) code that does the same and is understood. But there are things beyond syntax that are possibly not supported: features. Like for example Promises. Or certain features of other builtin types like <code>Object.is</code> or <code>Array.from</code> or whole new types like <code>Map</code> or <code>Set</code>. Therefore we need polyfills that recreate those features for targets that do not support them natively. </p>
<p>Also note that we are talking here only about polyfills for ES-features or some closely related Web Platform features (see the <a href="https://github.com/zloirock/core-js/blob/master/README.md#features">full list here</a>). There are browser features like for instance the global <code>fetch</code> function that need separate polyfills.</p>
<h3 id="Import-core-js"><a href="#Import-core-js" class="headerlink" title="Import core-js"></a><a name="tmplfwb-import-core-js"></a>Import core-js</h3><p>Ok, so there is a Babel package called <code>@babel/polyfill</code> that you can import at the entry point of your application and it adds all needed polyfills from a library called <a href="https://github.com/zloirock/core-js"><code>core-js</code></a> as well as a separate runtime needed for <code>async/await</code> and generator functions. <strong>But since Babel 7.4.0 this wrapper package is deprecated.</strong> Instead you should install and import two separate packages: <code>core-js/stable</code> and <code>regenerator-runtime/runtime</code>.</p>
<p>Then, we can get a nice effect from our <code>env</code> preset from above. We change the configuration to this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  <span class="string">'@babel/env'</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    modules: <span class="literal">false</span>,</span><br><span class="line">    corejs: <span class="number">3</span>,</span><br><span class="line">    useBuiltIns: <span class="string">'usage'</span></span><br><span class="line">  &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>This will transform our code so that the import of the whole <code>core-js</code> gets removed and instead Babel injects specific polyfills in each file where they are needed. And only those polyfills that are needed in the target environment which we have defined via <code>browserslist</code>. So we end up with the bare minimum of additional code.</p>
<p>Two additional notes here: (1) <a name="tmplfwb-corejs-3"></a>You have to explicitly set <code>corejs</code> to <code>3</code>. If the key is absent, Babel will use version 2 of <code>corejs</code> and you don’t want that. Much has changed for the better in version 3, especially feature-wise. But also bugs have been fixed and the package size is dramatically smaller. If you want, read it all up <a href="https://github.com/zloirock/core-js/blob/master/docs/2019-03-19-core-js-3-babel-and-a-look-into-the-future.md#what-changed-in-core-js3">here (overview)</a> and <a href="https://github.com/zloirock/core-js/blob/master/CHANGELOG.md#300---20190319">here (changelog for version 3.0.0)</a>.</p>
<p>And (2), there is another possible value for <code>useBuiltIns</code> and that is <code>entry</code>. This variant will not figure out which features your code actually needs. Instead, it will just add <em>all</em> polyfills that exist for the given target environment. It works by looking for <code>corejs</code> imports in your source (like <code>import corejs/stable</code>) which should only appear once in your codebase, probably in your entry module. Then, it replaces this “meta” import with all of the specific imports of polyfills that match your targets. This approach will likely result in a much, much larger package with much of unneeded code. So we just use <code>usage</code>. (With <code>corejs@2</code> there were a few problems with <code>usage</code> that could lead to wrong assumptions about which polyfills you need. So in some cases <code>entry</code> was the more safe option. But these problems are appearently fixed with version 3.)</p>
<h3 id="Tell-transform-runtime-to-import-core-js"><a href="#Tell-transform-runtime-to-import-core-js" class="headerlink" title="Tell transform-runtime to import core-js"></a>Tell transform-runtime to import core-js</h3><p>The second way to get the polyfills that your code needs is via the <code>transform-runtime</code> plugin from above. You can configure it to inject not only imports for the Babel helpers but also for the <code>core-js</code> modules that your code needs:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins: [</span><br><span class="line">  [</span><br><span class="line">    <span class="string">'@babel/plugin-transform-runtime'</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      corejs: <span class="number">3</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>This tells the plugin to insert import statements to corejs version 3. The reason for this version I have mentioned <a href="https://github.com/zloirock/core-js/blob/master/docs/2019-03-19-core-js-3-babel-and-a-look-into-the-future.md#what-changed-in-core-js3">above</a>.</p>
<p>If you configure the plugin to use <code>core-js</code>, you have to change the runtime dependency: The <code>peerDependencies</code> should now contain not <code>@babel/runtime</code> but <code>@babel/runtime-corejs3</code>!</p>
<h3 id="Which-way-should-you-use"><a href="#Which-way-should-you-use" class="headerlink" title="Which way should you use?"></a>Which way should you use?</h3><p>In general, the combination of manual import and the <code>env</code> preset is meant for applications and the way with <code>transform-runtime</code> is meant for libraries. One reason for this is that the first way of using <code>core-js</code> imports polyfills that “pollute” the global namespace. And if your library defines a global <code>Promise</code>, it could interfere with other helper libraries used by your library’s users. The imports that are injected by <code>transform-runtime</code> are contained. They import from <code>core-js-pure</code> which does not set globals.</p>
<p>On the other hand, using the transform plugin does not account for the environment you are targeting. Probably in the future it could also use the same heuristics as <code>preset-env</code> but at the moment it just adds every polyfill that is theoretically needed by your code. Even if the target browsers would not need them or not all of them. For the development in that direction see the <a href="https://github.com/zloirock/core-js/blob/master/docs/2019-03-19-core-js-3-babel-and-a-look-into-the-future.md#babelruntime-for-target-environment">comment from the corejs maintainer</a> and this <a href="https://github.com/babel/babel/issues/10008">RFC issue at Babel</a>.</p>
<p>So it looks like you have to choose between a package that adds as few code as possible and one that plays nicely with unknown applications around it. I have played around with the different options a bit and bundled the resulting files with webpack and this is my result:</p>
<p>You get the smallest bundle with the <code>core-js</code> globals from <code>preset-env</code>. But it’s too dangerous for a library to mess with the global namespace of its users. Besides that, in the (hopefully very near) future the transform-runtime plugin will also use the browserslist target environments. So the size issue is going to go away. </p>
<h3 id="The-env-key"><a href="#The-env-key" class="headerlink" title="The env key"></a>The <code>env</code> key</h3><p>With <code>env</code> you can add configuration options for specific build environments. When Babel executes it will look for <code>process.env.BABEL_ENV</code>. If that’s not set, it will look up <code>process.env.NODE_ENV</code> and if that’s not found, it will fallback to the string <code>&#39;development&#39;</code>. After doing this lookup it will check if the config has an <code>env</code> object and if there is a key in that object that matches the previously found env string. If there is such a match, Babel applies the configuration under that env name.</p>
<p>We use it for example for our test runner <a href="https://jestjs.io/">Jest</a>. Because Jest can not use ESModules we need a Babel config that transpiles our modules to CommonJS modules. So we just add an alternative configuration for <code>preset-env</code> under the env name <code>&#39;test&#39;</code>. When Jest runs (We will use <code>babel-jest</code> for this. See in a later part of this series.) it sets <code>process.env.NODE_ENV</code> to <code>&#39;test&#39;</code>. And so everything will work.</p>
<h3 id="Conclusion-and-final-notes-for-Babel-setup"><a href="#Conclusion-and-final-notes-for-Babel-setup" class="headerlink" title="Conclusion and final notes for Babel setup"></a><a name="tmplfwb-conclusion"></a>Conclusion and final notes for Babel setup</h3><p>Install all needed packages:</p>
<p><code>npm i -D @babel/core @babel/cli @babel/preset-env @babel/plugin-transform-runtime</code></p>
<p>Add a peerDependency to your <code>package.json</code> that your users should install themselves:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">...</span></span><br><span class="line">  <span class="string">"peerDependencies"</span>: &#123;</span><br><span class="line">      <span class="string">"@babel/runtime-corejs3"</span>: <span class="string">"^7.4.5"</span>, <span class="comment">// at least version 7.4; your users have to provide it</span></span><br><span class="line">  &#125;</span><br><span class="line"><span class="attr">...</span></span><br></pre></td></tr></table></figure>
<p>Create a <code>babel.config.js</code> that contains at least this:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// babel.config.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  presets: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@babel/env'</span>, <span class="comment">// transpile for targets</span></span><br><span class="line">      &#123;</span><br><span class="line">        modules: <span class="literal">false</span>, <span class="comment">// don't transpile module syntax</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">  ],</span><br><span class="line">  plugins: [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'@babel/plugin-transform-runtime'</span>, <span class="comment">// replace helper code with runtime imports (deduplication)</span></span><br><span class="line">      &#123; corejs: <span class="number">3</span> &#125; <span class="comment">// import corejs polyfills exactly where they are needed</span></span><br><span class="line">    ]</span><br><span class="line">  ],</span><br><span class="line">  env: &#123;</span><br><span class="line">    test: &#123; <span class="comment">// extra configuration for process.env.NODE_ENV === 'test'</span></span><br><span class="line">      presets: [<span class="string">'@babel/env'</span>] <span class="comment">// overwrite env-config from above with transpiled module syntax</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If you write TypeScript, run <code>npm i -D @babel/preset-typescript</code> and add <code>&#39;@babel/preset-typescript&#39;</code> to the <code>presets</code>.</p>
<p>If you write React code, (JSX) run <code>npm i -D @babel/preset-react</code> and add <code>&#39;@babel/preset-react&#39;</code> to the <code>presets</code>.</p>
<p>Add a <code>browserslist</code> section in your package.json:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">  "browserslist": [</span><br><span class="line">    "last 2 Chrome versions",</span><br><span class="line">    "last 2 Firefox versions",</span><br><span class="line">    "last 2 Edge versions",</span><br><span class="line">    "last 2 Opera versions",</span><br><span class="line">    "last 2 FirefoxAndroid versions",</span><br><span class="line">    "last 2 iOS version",</span><br><span class="line">    "last 2 safari version"</span><br><span class="line">  ]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>In case of using another browserslist query that includes targets that do not have support for generator functions and/or async/await, there is something you have to tell your users:</p>
<p>Babel’s transform-runtime plugin will import <code>regenerator-runtime</code>. This library depends on a globally available Promise constructor. <strong>But</strong> Babel will not include a promise polyfill for regenerator-runtime. Probably because it adds polyfills only for things genuinely belonging to <em>your</em> code, not external library code. That means, if your usecase meets these conditions, you should mention it in your README or installation instructions that the users of your lib have to make sure there is a Promise available in their application.</p>
<p>And that is it for the Babel setup.</p>
<p>Next up: Compiling with the TypeScript compiler</p>

	</div>
</article>

	
		<article id="Publish-a-modern-JavaScript-or-TypeScript-library" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/07/Publish-a-modern-JavaScript-or-TypeScript-library/">
	
		<h2 class="blog-post-title">Publish a modern JavaScript (or TypeScript) library</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-07-05T14:02:26.000Z">05. Juli 2019</time></p>
	</header>
	<div class="blog-post-content">
		<p>Did you ever write some library code together and then wanted to publish it as an NPM package but realized you have no idea what is the technique du jour to do so?</p>
<p>Did you ever wonder “Should I use Webpack or Rollup?”, “What about ES modules?”, “What about any other package format, actually?”, “How to publish Types along with the compiled code?” and so on?</p>
<p>Perfect! You have found the right place. In this series of articles I will try to answer every one of these questions. With example configurations for most of the possible combinations of these tools and wishes.</p>
<h3 id="Technology-base"><a href="#Technology-base" class="headerlink" title="Technology base"></a>Technology base</h3><p>This is the set of tools and their respective version range for which this tutorial is tested:</p>
<ul>
<li>ES2018 </li>
<li>Webpack &gt;= 4</li>
<li>Babel &gt;= 7.4</li>
<li>TypeScript &gt;= 3</li>
<li>Rollup &gt;= 1</li>
<li>React &gt;= 16.8<br>( code aimed at other libraries like Vue or Angular should work the same )</li>
</ul>
<p>Some or even most of that what follows could be applied to older versions of these tools, too. But I will not guarantee or test it. </p>
<h3 id="Creation"><a href="#Creation" class="headerlink" title="Creation"></a>Creation</h3><p>The first thing to do before publishing a library is obviously to write one. Let’s say we have already done that. In fact, it’s <a href="https://github.com/4nduril/library-starter/tree/init">this one</a>. It consists of several source files and therefore, modules. We have provided our desired functionality, used our favorite, modern JavaScript (or TypeScript) features and crafted it with our beloved editor settings.</p>
<p>What now? What do we want to achieve in this tutorial?</p>
<ol>
<li>Transpile modern language features so that every browser in one of the last 2 versions can understand our code.</li>
<li>Avoid duplicating compile-stage helpers to keep the library as small as possible.</li>
<li>Ensure code quality with linting and tests.</li>
<li>Bundle our modules into one consumable, installable file.</li>
<li>Provide ES modules to make the library tree-shakable.</li>
<li>Provide typings if we wrote our library in TypeScript.</li>
<li>Improve collaborating with other developers (from our team or, if it is an open source library, from the public).</li>
</ol>
<p>Wow. That’s a whole lot of things. Let’s see if we can make it.</p>
<p>Note that some of these steps can be done with different tools or maybe differ depending on the code being written in TypeScript or JavaScript. We’ll cover all of that. Well, probably not all of that, but I will try to cover the most common combinations.</p>
<p>The chapters of this series will not only show configurations I think you should use, but also will I explain the reasoning behind it and how it works. If you aren’t interested in these backgrounds, there will be a link right at the top of each post down to the configurations and steps to execute without much around.</p>
<h3 id="Go"><a href="#Go" class="headerlink" title="Go!"></a>Go!</h3><p>We will start with the first points on our list above. As new articles arrive, I will add them here as links and I will also try to keep the finished articles updated when the tools they use get new features or change APIs. If you find something that’s not true anymore, please give me a hint.</p>
<ol>
<li><a href="http://tobias-barth.net/blog/2019/07/Transpile-modern-language-features-with-Babel/">Transpile modern language features – With Babel</a>.</li>
</ol>
<p>Oh and one last thing™: I’ll be using <code>npm</code> throughout the series because I like it. If you like <code>yarn</code> better, just exchange the commands.</p>

	</div>
</article>

	
		<article id="Resize-LVM-on-LUKS-partition-without-messing-everything-up" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/06/Resize-LVM-on-LUKS-partition-without-messing-everything-up/">
	
		<h2 class="blog-post-title">Resize LVM on LUKS partition without messing everything up</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-06-10T11:49:27.000Z">10. Juni 2019</time></p>
	</header>
	<div class="blog-post-content">
		<p>Since forever I run my work computer operating systems on a full-disk-encrypted partition. Currently this is Manjaro Linux. When I set up my current machine I made the following partition scheme:</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sda                  <span class="number">238</span>,<span class="number">5</span>G  disk</span><br><span class="line">├─sda1                 <span class="number">260</span>M  <span class="keyword">part</span>  /boot/efi</span><br><span class="line">├─sda2                 <span class="number">128</span>M  <span class="keyword">part</span>  /boot</span><br><span class="line">└─sda3                 <span class="number">237</span>G  <span class="keyword">part</span></span><br><span class="line">  └─tank               <span class="number">237</span>G  crypt</span><br></pre></td></tr></table></figure>
<p>Somewhere, I can’t even remember when, I read that 128M for <code>/boot</code> would be sufficient. And it was for a few years. But kernel images and/or initram disks grew bigger and bigger until I could not upgrade to a newer kernel anymore. The last kernel I ran was Linux 4.16 and the files in <code>/boot</code> took around 75M space and so <code>mhwd-kernel -i linux417</code> had too little space on the device left.</p>
<p>What I needed to do was to shrink <code>/dev/sda3</code>, move it to the end of the SSD and grow <code>/dev/sda2</code> as necessary.</p>
<p>But I did not know if this was even possible with my setup. Inside the encrypted partition there is an LVM container with 5 logical volumes including <code>/</code>. I pushed it into the future again and again because most of the time I am working in running projects and can not afford to have a non-functioning machine for \<absurd amount of time that you never expect before a hardware near change\>.</p>
<p>But in the end it was relatively easy. I had feared that in the worst case I would have to re-setup my whole machine and restore backups for the data and system partitions. Which then maybe would need endless tweaking until it runs again (No, I never had a hard disk failure or similar, so I never had to actually do anything like that).</p>
<p>So, here are the things I needed to do:</p>
<h2 id="1-Backup"><a href="#1-Backup" class="headerlink" title="1. Backup"></a>1. Backup</h2><p>List all logcal volumes:<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lvs</span></span><br><span class="line">LV     VG   Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert</span><br><span class="line">docker tank -wi-ao<span class="comment">----   5,00g                                        </span></span><br><span class="line">home   tank -wi-ao<span class="comment">---- 100,00g                                        </span></span><br><span class="line">mongo  tank -wi-ao<span class="comment">----   1,00g                                        </span></span><br><span class="line">root   tank -wi-ao<span class="comment">----  25,00g                                        </span></span><br><span class="line">swap   tank -wc-ao<span class="comment">----  32,00g</span></span><br></pre></td></tr></table></figure></p>
<p>For each lv do the following:<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># lvcreate -s -n &lt;<span class="keyword">name</span>&gt;snap /dev/tank/&lt;<span class="keyword">name</span>&gt;</span><br><span class="line"># dd <span class="keyword">if</span>=/dev/tank/&lt;<span class="keyword">name</span>&gt;snap of=/path/to/<span class="keyword">external</span>/storage/&lt;<span class="keyword">name</span>&gt;.img</span><br></pre></td></tr></table></figure></p>
<p>Where <code>&lt;name&gt;</code> must be replaced by the actual names of the lvs. Then I backed up both the <code>/boot</code> and the <code>/boot/efi</code> partitions, also with <code>dd</code>.<br>Finally I made a backup of the LUKS header for the crypto-partition:<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cryptsetup luksHeaderBackup <span class="regexp">/dev/</span>sda3 --header-backup-<span class="keyword">file</span> <span class="regexp">/path/</span>to<span class="regexp">/external/</span>storage<span class="regexp">/luks-header.bkp</span></span><br></pre></td></tr></table></figure></p>
<h2 id="2-Boot-in-a-live-system-from-an-USB-stick-and-decrypt-the-device"><a href="#2-Boot-in-a-live-system-from-an-USB-stick-and-decrypt-the-device" class="headerlink" title="2. Boot in a live system from an USB stick and decrypt the device"></a>2. Boot in a live system from an USB stick and decrypt the device</h2><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># cryptsetup <span class="keyword">open</span> /dev/sda3 tank --<span class="class"><span class="keyword">type</span> <span class="title">luks</span></span></span><br></pre></td></tr></table></figure>
<h2 id="3-Resize-the-physical-volume"><a href="#3-Resize-the-physical-volume" class="headerlink" title="3. Resize the physical volume"></a>3. Resize the physical volume</h2><p><strong>Note:</strong> I have free space inside my LVM container. As you can see from the output of <code>lvs</code> above I currently use only 143GB out of roughly 238GB. That means I do not have to resize logical volumes <em>before</em> I resize the containing physical volume. If you use all of the available space for logical volumes, look into <a href="https://jlk.fjfi.cvut.cz/arch/manpages/man/lvresize.8"><code>lvresize(8)</code></a> first: For example in the  <a href="https://wiki.archlinux.org/index.php/LVM#Resizing_volumes">Arch Wiki</a>.</p>
<p>I generously shrank the volume from 238,07G to 236G with:<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># pvresize --setphysicalvolumesize 236G /dev/mapper/tank</span></span><br></pre></td></tr></table></figure></p>
<h2 id="4-Resize-the-crypto-device"><a href="#4-Resize-the-crypto-device" class="headerlink" title="4. Resize the crypto-device"></a>4. Resize the crypto-device</h2><p>Find out how many sectors is the current size (note that my crypto-device has the same name like my volume group: <code>tank</code>. That could be different in your setup):<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cryptsetup status tank</span></span><br><span class="line">...</span><br><span class="line">sector <span class="built_in">size</span>:  <span class="number">512</span></span><br><span class="line"><span class="built_in">size</span>:  <span class="number">499122176</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>In the end I want to add about 1G to the <code>/boot</code> partition. That is <code>1024 * 1024 * 1024 / 512 = 2097152</code> sectors.<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># cryptsetup -b 497025024 resize tank</span></span><br></pre></td></tr></table></figure></p>
<h2 id="5-Resize-the-GUID-partition"><a href="#5-Resize-the-GUID-partition" class="headerlink" title="5. Resize the GUID partition"></a>5. Resize the GUID partition</h2><p>You see we go from innermost to outermost: LVM -&gt; crypto -&gt; GUID. I use <code>parted</code> to resize the partition <code>/dev/sda3</code>:<br><figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># parted</span><br><span class="line">(parted) <span class="keyword">unit</span> s</span><br><span class="line">(parted) <span class="built_in">print</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">Number</span>  Begin     <span class="keyword">End</span>         <span class="built_in">Size</span>                     <span class="keyword">Name</span>  Flags</span><br><span class="line">...</span><br><span class="line"><span class="number">3</span>      100672s  00115455s  97014784s               TANK  lvm</span><br></pre></td></tr></table></figure></p>
<p>These numbers were actually different as I write this blog post in hindsight. The point is that partition number 3 went all the way to the last sector of the disk and I now must calculate where it should end in the future. Because <code>resizepart</code> takes not the future size but the future end sector of the partition as argument. So I subtract the same sector count as calculated above for cryptsetup (<code>2097152</code>) from the <em>end sector</em> of partition 3 (<code>500115455</code>) which gives <code>498018303</code>.<br><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(<span class="name">parted</span>) resizepart <span class="number">3</span> <span class="number">498018303</span>s</span><br></pre></td></tr></table></figure></p>
<p>Now we have free space on the SSD <em>after</em> the main partition. But I want to grow partition 2.</p>
<h2 id="6-Reorder-partitions-and-resize-partition-2"><a href="#6-Reorder-partitions-and-resize-partition-2" class="headerlink" title="6. Reorder partitions and resize partition 2"></a>6. Reorder partitions and resize partition 2</h2><p>I did that with GParted instead of a command line tool. Probably there is a way to do it with <code>gdisk</code> but <code>parted</code> has removed its command to <code>move</code> partitions. And because I was in a graphical live system anyway and also read that you could do it with GParted I just went for it.<br>First I closed the crypto device because GParted would not let me move the partition otherwise:<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># vgchange -an tank</span></span><br><span class="line"><span class="meta"># cryptsetup close tank</span></span><br></pre></td></tr></table></figure></p>
<p>Then I opened GParted and right-clicked on the crypto partition. I chose “Change size|Move” and moved the free space after the partition before it. Then I opend the same dialog for the <code>/boot</code> partition and extended it to cover all of the free space. Finally I committed the changes.</p>

	</div>
</article>

	
		<article id="Handle-lid-closing-correctly-in-XFCE-power-settings" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/05/Handle-lid-closing-correctly-in-XFCE-power-settings/">
	
		<h2 class="blog-post-title">Handle lid closing correctly in XFCE power settings</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-05-21T13:55:25.000Z">21. Mai 2019</time></p>
	</header>
	<div class="blog-post-content">
		<p>This is mainly just a note for my future self. I always had problems with the power management settings on my laptop. It’s running Manjaro Linux (Arch derivate). Regardless of what I set in the XFCE power settings, the actions that should happen on lid closing didn’t work as expected. I wanted that the machine does a suspend-to-RAM when I close the lid and the power cable is plugged in. And when it is not plugged in I wanted the machine to suspend-to-disk (hibernate). </p>
<p>On some point I just disabled everything in <code>/etc/systemd/logind.conf</code> (set it to ignore lid actions) and lived with the fact.</p>
<p>Today on Googling™ I came across two things: First a mention of the file <code>~/.config/xfce4/xconf/xfce-perchannel-xml/xfce4-power-manager.xml</code>. There, all the settings you can set in the graphical power settings tool are saved as XML. Second: A forum post (<a href="https://bbs.archlinux.org/viewtopic.php?pid=1690134#p1690134">https://bbs.archlinux.org/viewtopic.php?pid=1690134#p1690134</a>) that points to the fact that in this XML file there is a setting you can’t set graphical: “logind-handle-lid-switch”. Which is set to <code>true</code> for reasons that are beyond me.</p>
<p>Probably you can do all sorts of things with <code>acpid</code> and/or systemd to control the actions on lid-close and lid-open. But you can also just issue:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xfconf-query -c xfce4-power-manager -p /xfce4-power-manager/logind-handle-lid-switch <span class="_">-s</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p>on the shell and then your settings in XFCEs power settings are used by the system and work. Of course I also set the content in <code>logind.conf</code> back to default.</p>

	</div>
</article>

	
		<article id="Fix-speed-issue-when-writing-to-NAS-system" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/05/Fix-speed-issue-when-writing-to-NAS-system/">
	
		<h2 class="blog-post-title">Fix speed issue when writing to NAS system</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-05-03T09:36:54.000Z">03. Mai 2019</time></p>
	</header>
	<div class="blog-post-content">
		<p>I just fixed an issue with my FreeBSD home server. It is set up as a file server for Mac (AFP) and Linux Clients (NFS). My local network is Gigabit-based sothe limitating factor on read/write speeds should be the hard disk drives in the server.</p>
<p>The server has a Core i3-6100T CPU @ 3.20GHz, 8GB RAM, a ZFS setup with two mirror vdevs each consisting of two disks connected to the board via SATA3. And of course the onboard Gbit NIC (Realtek).</p>
<p>I know very well that write speed was at around 50–60MB/sec, which I would expect. But lately, it dropped amazingly to ~1MB/sec. And I just couldn’t think of, why. I suspected the cable, the AFP, the RAM anything.</p>
<p>What I didn’t suspect — until today, that is — was the network interface. But I had time today for some googling and even if I didn’t found the solution directly, I stumbled across something related to the output of <code>ifconfig</code>. So I hacked that into the console and stared at it.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">re0:</span> flags=<span class="number">8843</span>&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; metric <span class="number">0</span> mtu <span class="number">1500</span></span><br><span class="line">        options=<span class="number">8209</span>b&lt;RXCSUM,TXCSUM,VLAN_MTU,VLAN_HWTAGGING,VLAN_HWCSUM,WOL_MAGIC,LINKSTATE&gt;</span><br><span class="line">        ether <span class="number">4</span><span class="string">c:</span><span class="string">cc:</span><span class="number">6</span><span class="string">a:</span><span class="string">b3:</span><span class="number">3</span><span class="string">c:</span>f5</span><br><span class="line">        hwaddr <span class="number">4</span><span class="string">c:</span><span class="string">cc:</span><span class="number">6</span><span class="string">a:</span><span class="string">b3:</span><span class="number">3</span><span class="string">c:</span>f5</span><br><span class="line">        inet6 <span class="string">fd23:</span><span class="number">16</span>:<span class="number">7</span>:<span class="number">7</span>::<span class="number">1</span> prefixlen <span class="number">64</span></span><br><span class="line">        inet6 <span class="string">fe80:</span>:<span class="number">4</span><span class="string">ecc:</span><span class="number">6</span><span class="string">aff:</span><span class="string">feb3:</span><span class="number">3</span>cf5%re0 prefixlen <span class="number">64</span> scopeid <span class="number">0x1</span></span><br><span class="line">        inet <span class="number">192.168</span><span class="number">.10</span><span class="number">.118</span> netmask <span class="number">0xffffff00</span> broadcast <span class="number">192.168</span><span class="number">.10</span><span class="number">.255</span></span><br><span class="line">        nd6 options=<span class="number">21</span>&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;</span><br><span class="line"><span class="symbol">        media:</span> Ethernet autoselect (<span class="number">10</span>baseT/UTP &lt;full-duplex&gt;)</span><br><span class="line"><span class="symbol">        status:</span> active</span><br></pre></td></tr></table></figure>
<p>Do you spot it? </p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">media:</span> Ethernet autoselect (<span class="number">10</span>baseT/UTP <span class="params">&lt;full-duplex&gt;</span>)</span><br></pre></td></tr></table></figure>
<p>Well, that is … unfortunate. The output of <code>ifconfig -m re0</code> gave me:</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">supported media:</span><br><span class="line">		media autoselect mediaopt flowcontrol</span><br><span class="line">		media autoselect</span><br><span class="line">		media <span class="number">1000</span>baseT mediaopt <span class="literal">full</span><span class="attr">-duplex</span>,flowcontrol,master</span><br><span class="line">		media <span class="number">1000</span>baseT mediaopt <span class="literal">full</span><span class="attr">-duplex</span>,flowcontrol</span><br><span class="line">		media <span class="number">1000</span>baseT mediaopt <span class="literal">full</span><span class="attr">-duplex</span>,master</span><br><span class="line">		media <span class="number">1000</span>baseT mediaopt <span class="literal">full</span><span class="attr">-duplex</span></span><br><span class="line">		media <span class="number">100</span>baseTX mediaopt <span class="literal">full</span><span class="attr">-duplex</span>,flowcontrol</span><br><span class="line">		media <span class="number">100</span>baseTX mediaopt <span class="literal">full</span><span class="attr">-duplex</span></span><br><span class="line">		media <span class="number">100</span>baseTX</span><br><span class="line">		media <span class="number">10</span>baseT/UTP mediaopt <span class="literal">full</span><span class="attr">-duplex</span>,flowcontrol</span><br><span class="line">		media <span class="number">10</span>baseT/UTP mediaopt <span class="literal">full</span><span class="attr">-duplex</span></span><br><span class="line">		media <span class="number">10</span>baseT/UTP</span><br><span class="line">		media <span class="literal">none</span></span><br></pre></td></tr></table></figure>
<p>So I ran <code>sudo ifconfig re0 media 1000baseTX mediaopt full-duplex</code> and it worked. After that I also ran <code>sudo ifconfig re0 media autoselect</code> which also set the media type to 1000baseT full-duplex. I have no idea why the system did that wrong (or when) but I will monitor what happens after the next reboot. Maybe I have to do some configuration but maybe it was just an hickup.</p>
<p>Speeds are up to 60MB/sec again.</p>

	</div>
</article>

	
		<article id="Execute-Promise-based-code-in-order-over-an-array" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/04/Execute-Promise-based-code-in-order-over-an-array/">
	
		<h2 class="blog-post-title">Execute Promise-based code in order over an array</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-04-18T12:47:53.000Z">18. April 2019</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h3><p>I recently faced a problem: I had a list (an array) of input data and wanted to execute a function for every item in that list. </p>
<p>No problem, you say, take <code>Array.prototype.map</code>, that’s what it’s for. <strong>BUT</strong> the function in question returns a Promise and I want to be able to only continue in the program flow when all of these Promises are resolved.</p>
<p>No problem, you say, wrap it in <code>Promise.all</code>, that’s what it’s for. <strong>BUT</strong> the function in question is very expensive. So expensive that it spawns a child process (the whole code runs in NodeJS on my computer) and that child process is using so much CPU power that my computer comes to grinding halt when my input list is longer than a few elements.</p>
<p>And that’s because effectively, all the heavy child processes get started in near parallel. Actually they get started in order but the next will not wait for the previous to finish.</p>
<h3 id="The-first-solution"><a href="#The-first-solution" class="headerlink" title="The first solution"></a>The first solution</h3><p>So what I need is a way to traverse the array, execute the function for the current element, <em>wait</em> until the Promise resolves and <em>only then</em> go to the next element and call the function with it. That means <code>map</code> will not work because I have no control over the execution flow. So I will have to build my own <code>map</code>. And while I am on it, I will implement it a bit nicer as stand-alone function that takes the mapper function first and then the data array:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequentialMap = fn =&gt;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">innerSequentialMap</span>(<span class="params">[head, ...tail]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!head) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve([])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fn(head).then(headResult =&gt;</span><br><span class="line">      innerSequentialMap(tail).then(tailResult =&gt; [headResult, ...tailResult])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>So, what does this? It takes the function <code>fn</code> that should be applied to all values in the array and returns a new function. This new function expects an array as input. You see that the function is curried in that it takes only ever one argument and the real execution starts when all arguments are provided. That allows us for example to “preload” <code>sequentialMap</code> with a mapper function and reuse it on different input data:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// preloading</span></span><br><span class="line"><span class="keyword">const</span> mapWithHeavyComputations = sequentialMap(heavyAsyncComputation)</span><br><span class="line"></span><br><span class="line"><span class="comment">// execution</span></span><br><span class="line"><span class="keyword">const</span> result = mapWithHeavyComputations([…])</span><br></pre></td></tr></table></figure>
<p>But in this case the currying enables (or simplifies) another technique: recursion.</p>
<p>We say a function is recursive when it calls itself repeatedly. Recursion is the functional equivalent to looping in imperative programming. You can refactor one into the other as long as the programming language allows both ways. Or so I thought.</p>
<p>I used a recursive function here because I could not think of a way to wait for a Promise resolving in a loop. How would I use <code>.then()</code> and jump to the next iteration step <em>within</em> that <code>then</code>?</p>
<p>Anyway, let’s go further through the code. In the body of the internal or second function firstly I define a condition to terminate the recursion: I check if the first element is falsy and if it is falsy I just return a Promise that resolves to an empty array. That is because the main path of the function returns its data as an array wrapped in a Promise. So if we return the same type of data when we terminate all will fit nicely together.</p>
<p>Next, if we don’t terminate (which means the first element of the given list is truthy) we apply the mapper function to it. That will return a Promise and we wait for its resolving with <code>.then</code>. Once it resolves the whole thing gets a bit magical, but not too much.</p>
<p>What we do then is to build a nested Promise. Normally, when you work with Promises and want to apply several functions to the inner values you would build a “Promise chain”:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = firstPromise</span><br><span class="line">  .then(doSomethingWithIt)</span><br><span class="line">  .then(doSomthingElseAfterThat)</span><br><span class="line">  …</span><br></pre></td></tr></table></figure>
<p>The problem we have here is that to build the final result (the mapped array), we need the result from the first resolved Promise and then also the result values from all the other Promises which are not computed <em>upon</em> each other but <em>independent</em>.</p>
<p>So we use two features to solve that: nested scope and Promise-flattening (did someone say Monad?).</p>
<p>For the nested scope first: When we define a function within a function then the inner function can access variables that are defined not within itself but in the outer function (the outer or surrounding scope):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outer</span>(<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> outerValue = arg1 + <span class="number">42</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> outerValue + <span class="number">23</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(inner())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outer(<span class="number">666</span>) <span class="comment">// logs 731</span></span><br></pre></td></tr></table></figure>
<p>And Promise-flattening means essentially that if you have a Promise of a Promise of a value that is the same as if you just had a Promise of the value.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> p2 = <span class="built_in">Promise</span>.resolve(<span class="built_in">Promise</span>.resolve(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">const</span> p1 = <span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p2.then(<span class="built_in">console</span>.log) <span class="comment">// logs 1</span></span><br><span class="line">p1.then(<span class="built_in">console</span>.log) <span class="comment">// logs 1</span></span><br></pre></td></tr></table></figure>
<p>To recall, here is what the code we are talking about looks like:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> fn(head).then(headResult =&gt;</span><br><span class="line">  sequentialMapInternal(tail).then(tailResult =&gt; [headResult, ...tailResult])</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>We keep the <code>headResult</code> in scope and then we generate the next Promise by calling the inner function recursively again but with a shorter list without the first element. We wait again with <code>.then</code> for the final result and only then we build our result array.</p>
<p>This is done by spreading the <code>tailResult</code> after the <code>headResult</code>: We know we get one value from calling <code>fn(head)</code> but we get a list of values from calling <code>sequentialMapInternal(tail)</code>. So with the spread operator we get a nice flat array of result values.</p>
<p>Note that the function inside the first <code>then</code>, that gets <code>headResult</code> as parameter immediately returns the next Promise(-chain). And that is essentially where we use Promise-flattening. <code>.then</code> returns a Promise in itself and now we are returning a Promise inside of that. But the result will look like an ordinary Promise – no nesting visible.</p>
<h3 id="The-better-way"><a href="#The-better-way" class="headerlink" title="The better way"></a>The better way</h3><p>While that works perfectly and my computer remains usable also when I call my script now, all these nested <code>then</code>s do not look so nice. We can fix that when we have async functions at our disposal:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sequentialMap = fn =&gt;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">innerSequentialMap</span>(<span class="params">[head, ...tail]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!head) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve([])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> headResult = <span class="keyword">await</span> fn(head)</span><br><span class="line">    <span class="keyword">const</span> tailResult = <span class="keyword">await</span> innerSequentialMap(tail)</span><br><span class="line">    <span class="keyword">return</span> [headResult, ...tailResult]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Yes, that is much better. Now the exection is paused until <code>headResult</code> is there and then paused again until <code>tailResult</code> is there and only then we build our result array and are finished.</p>
<h3 id="The-shortest-way"><a href="#The-shortest-way" class="headerlink" title="The shortest way"></a>The shortest way</h3><p>Wait. Did I just say I can pause execution with <code>await</code>? Wouldn’t this work also within a loop?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loopVersion = fn =&gt;</span><br><span class="line">  <span class="keyword">async</span> list =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> elem <span class="keyword">of</span> list) &#123;</span><br><span class="line">      result.push(<span class="keyword">await</span> fn(elem))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>See, this is what happens to people like me that are too deep into functional programming paradigms. Yes, you should generally avoid loops because they are not declarative and you end up telling the machine (and your coworker) not <em>what</em> you want to happen but <em>how</em> you want it to happen. That is, again, generally, no good practice. But in this case that is exactly what we wanted: To give a step-by-step schema on how to execute our code. To optimize for resource usage.</p>

	</div>
</article>

	

</div>

		</main>
	<footer class="site-footer h-card" aria-describedby="dse">
		<h3 class="in-site-footer cta">Kontaktieren Sie mich</h3>
		<p class="in-site-footer">Email: <a href="mailto:contact@tobias-barth.net" rel="me" class="u-email">contact@tobias-barth.net</a><br />
		Telefon: <a href="tel:+4915111215929">+49 151 112 15 929</a></p>
		<p id="dse" class="in-site-footer">(Bitte beachten Sie vor der Kontaktaufnahme meine Datenschutzerklärung.)</p>
		<h3 class="in-site-footer cta">Finden Sie mich</h3>
		<p class="in-site-footer"><img class="sm u-photo" src="/images/Portrait.png" alt="Mein Avatar" /><a class="sm fa fa-adn" href="https://alpha.app.net/4nduril" rel="me"><span>App.net</span></a> <a class="sm fa fa-twitter" href="https://twitter.com/4nduril" rel="me"><span>Twitter</span></a> <a class="sm fa fa-github-square" href="https://github.com/4nduril" rel="me"><span>Github</span></a></p>
		<h3 class="in-site-footer">Impressum</h3>
		<p class="in-site-footer">Inhaltlich verantwortlich gemäß § 5 <abbr title="Telemediengesetz">TMG</abbr>:<br />
		<a href="http://tobias-barth.net" class="p-name u-url">Tobias&nbsp;Barth</a><br />
		<span class="p-street-address">Vincenzstr.&nbsp;25</span><br />
		<span class="p-locality p-postal-code">51065&nbsp;Köln</span></p>
		<p class="in-site-footer">USt-ID: DE304359556</p>
		<h4 class="in-site-footer">Fotos</h4>
		<p class="in-site-footer">&copy;&nbsp;<a href="http://annebarth.de">Anne&nbsp;Barth</a></p>
		<p class="in-site-footer"><a href="dse.html">Datenschutzerklärung</a></p>
	</footer>
</body>

</html>
