<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="utf-8" />
	<title>tobias-barth.net | Moderne Webentwicklung aus Köln</title>
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/css/style.min.css" />
	<!--[if lt IE 9]>
		<link rel="stylesheet" href="/css/old-ie.min.css" />
	<![endif]-->

	<link rel="alternate" type="application/rss+xml" href="/blog/feed/rss.xml" />

</head>
<body>
	<header class="site-head">
			<a href="/"><h1 class="in-site-head">tobias-barth.net</h1>
			<p class="tagline in-site-head">Moderne Webentwicklung aus Köln</p></a>
		</header>


		<main>
			<nav class="main-navi" id="main-navi">
				<ul>
					<li><a href="/portfolio" title="Meine Fähigkeiten, Arbeitsfelder und Beispielprojekte"><span class="fa fa-wrench"></span> Ich mache</a></li>
				<li><a href="/blog" title="Mein Blog über Webentwicklung und Ähnliches"><span class="fa fa-pencil"></span> Ich schreibe</a></li>
<!--					<li><a href="" title="Lernen Sie mich besser kennen"><span class="fa fa-user"></span> Ich bin</a></li>-->
				</ul>
			</nav>
		<div class="blog-textcontainer">

	
		<article id="Execute-Promise-based-code-in-order-over-an-array" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2019/04/Execute-Promise-based-code-in-order-over-an-array/">
	
		<h2 class="blog-post-title">Execute Promise-based code in order over an array</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2019-04-18T12:47:53.000Z">18. April 2019</time></p>
	</header>
	<div class="blog-post-content">
		<h3 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h3><p>I recently faced a problem: I had a list (an array) of input data and wanted to execute a function for every item in that list. </p>
<p>No problem, you say, take <code>Array.prototype.map</code>, that’s what it’s for. <strong>BUT</strong> the function in question returns a Promise and I want to be able to only continue in the program flow when all of these Promises are resolved.</p>
<p>No problem, you say, wrap it in <code>Promise.all</code>, that’s what it’s for. <strong>BUT</strong> the function in question is very expensive. So expensive that it spawns a child process (the whole code runs in NodeJS on my computer) and that child process is using so much CPU power that my computer comes to grinding halt when my input list is longer than a few elements.</p>
<p>And that’s because effectively, all the heavy child processes get started in near parallel. Actually they get started in order but the next will not wait for the previous to finish.</p>
<h3 id="The-first-solution"><a href="#The-first-solution" class="headerlink" title="The first solution"></a>The first solution</h3><p>So what I need is a way to traverse the array, execute the function for the current element, <em>wait</em> until the Promise resolves and <em>only then</em> go to the next element and call the function with it. That means <code>map</code> will not work because I have no control over the execution flow. So I will have to build my own <code>map</code>. And while I am on it, I will implement it a bit nicer as stand-alone function that takes the mapper function first and then the data array:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> sequentialMap = fn =&gt;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">innerSequentialMap</span>(<span class="params">[head, ...tail]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!head) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve([])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fn(head).then(headResult =&gt;</span><br><span class="line">      innerSequentialMap(tail).then(tailResult =&gt; [headResult, ...tailResult])</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>So, what does this? It takes the function <code>fn</code> that should be applied to all values in the array and returns a new function. This new function expects an array as input. You see that the function is curried in that it takes only ever one argument and the real execution starts when all arguments are provided. That allows us for example to “preload” <code>sequentialMap</code> with a mapper function and reuse it on different input data:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// preloading</span></span><br><span class="line"><span class="keyword">const</span> mapWithHeavyComputations = sequentialMap(heavyAsyncComputation)</span><br><span class="line"></span><br><span class="line"><span class="comment">// execution</span></span><br><span class="line"><span class="keyword">const</span> result = mapWithHeavyComputations([…])</span><br></pre></td></tr></table></figure>
<p>But in this case the currying enables (or simplifies) another technique: recursion.</p>
<p>We say a function is recursive when it calls itself repeatedly. Recursion is the functional equivalent to looping in imperative programming. You can refactor one into the other as long as the programming language allows both ways. Or so I thought.</p>
<p>I used a recursive function here because I could not think of a way to wait for a Promise resolving in a loop. How would I use <code>.then()</code> and jump to the next iteration step <em>within</em> that <code>then</code>?</p>
<p>Anyway, let’s go further through the code. In the body of the internal or second function firstly I define a condition to terminate the recursion: I check if the first element is falsy and if it is falsy I just return a Promise that resolves to an empty array. That is because the main path of the function returns its data as an array wrapped in a Promise. So if we return the same type of data when we terminate all will fit nicely together.</p>
<p>Next, if we don’t terminate (which means the first element of the given list is truthy) we apply the mapper function to it. That will return a Promise and we wait for its resolving with <code>.then</code>. Once it resolves the whole thing gets a bit magical, but not too much.</p>
<p>What we do then is to build a nested Promise. Normally, when you work with Promises and want to apply several functions to the inner values you would build a “Promise chain”:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = firstPromise</span><br><span class="line">  .then(doSomethingWithIt)</span><br><span class="line">  .then(doSomthingElseAfterThat)</span><br><span class="line">  …</span><br></pre></td></tr></table></figure>
<p>The problem we have here is that to build the final result (the mapped array), we need the result from the first resolved Promise and then also the result values from all the other Promises which are not computed <em>upon</em> each other but <em>independent</em>.</p>
<p>So we use two features to solve that: nested scope and Promise-flattening (did someone say Monad?).</p>
<p>For the nested scope first: When we define a function within a function then the inner function can access variables that are defined not within itself but in the outer function (the outer or surrounding scope):</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">outer</span>(<span class="params">arg1</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> outerValue = arg1 + <span class="number">42</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">inner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> outerValue + <span class="number">23</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(inner())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">outer(<span class="number">666</span>) <span class="comment">// logs 731</span></span><br></pre></td></tr></table></figure>
<p>And Promise-flattening means essentially that if you have a Promise of a Promise of a value that is the same as if you just had a Promise of the value.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> p2 = <span class="built_in">Promise</span>.resolve(<span class="built_in">Promise</span>.resolve(<span class="number">1</span>))</span><br><span class="line"><span class="keyword">const</span> p1 = <span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p2.then(<span class="built_in">console</span>.log) <span class="comment">// logs 1</span></span><br><span class="line">p1.then(<span class="built_in">console</span>.log) <span class="comment">// logs 1</span></span><br></pre></td></tr></table></figure>
<p>To recall, here is what the code we are talking about looks like:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> fn(head).then(headResult =&gt;</span><br><span class="line">  sequentialMapInternal(tail).then(tailResult =&gt; [headResult, ...tailResult])</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>We keep the <code>headResult</code> in scope and then we generate the next Promise by calling the inner function recursively again but with a shorter list without the first element. We wait again with <code>.then</code> for the final result and only then we build our result array.</p>
<p>This is done by spreading the <code>tailResult</code> after the <code>headResult</code>: We know we get one value from calling <code>fn(head)</code> but we get a list of values from calling <code>sequentialMapInternal(tail)</code>. So with the spread operator we get a nice flat array of result values.</p>
<p>Note that the function inside the first <code>then</code>, that gets <code>headResult</code> as parameter immediately returns the next Promise(-chain). And that is essentially where we use Promise-flattening. <code>.then</code> returns a Promise in itself and now we are returning a Promise inside of that. But the result will look like an ordinary Promise – no nesting visible.</p>
<h3 id="The-better-way"><a href="#The-better-way" class="headerlink" title="The better way"></a>The better way</h3><p>While that works perfectly and my computer remains usable also when I call my script now, all these nested <code>then</code>s do not look so nice. We can fix that when we have async functions at our disposal:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> sequentialMap = fn =&gt;</span><br><span class="line">  <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">innerSequentialMap</span>(<span class="params">[head, ...tail]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!head) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve([])</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> headResult = <span class="keyword">await</span> fn(head)</span><br><span class="line">    <span class="keyword">const</span> tailResult = <span class="keyword">await</span> innerSequentialMap(tail)</span><br><span class="line">    <span class="keyword">return</span> [headResult, ...tailResult]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>Yes, that is much better. Now the exection is paused until <code>headResult</code> is there and then paused again until <code>tailResult</code> is there and only then we build our result array and are finished.</p>
<h3 id="The-shortest-way"><a href="#The-shortest-way" class="headerlink" title="The shortest way"></a>The shortest way</h3><p>Wait. Did I just say I can pause execution with <code>await</code>? Wouldn’t this work also within a loop?</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loopVersion = fn =&gt;</span><br><span class="line">  <span class="keyword">async</span> list =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> result = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> elem <span class="keyword">of</span> list) &#123;</span><br><span class="line">      result.push(<span class="keyword">await</span> fn(elem))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>See, this is what happens to people like me that are too deep into functional programming paradigms. Yes, you should generally avoid loops because they are not declarative and you end up telling the machine (and your coworker) not <em>what</em> you want to happen but <em>how</em> you want it to happen. That is, again, generally, no good practice. But in this case that is exactly what we wanted: To give a step-by-step schema on how to execute our code. To optimize for resource usage.</p>

	</div>
</article>

	
		<article id="Einfache-Foto-Upload-App-mit-Node-js" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2017/05/Einfache-Foto-Upload-App-mit-Node-js/">
	
		<h2 class="blog-post-title">Einfache Foto-Upload-App mit Node.js</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2017-05-30T17:08:00.000Z">30. Mai 2017</time></p>
	</header>
	<div class="blog-post-content">
		<p>Meine Frau brauchte für ein Projekt mit Kindern eine einfache Möglichkeit, Fotos von Smartphones auf ihren Laptop zu laden. Es gibt viele Methoden das zu machen: Bluetooth, USB, SD-Karten-Austausch, und natürlich die üblichen Internet-Lösungen wie Dropbox.</p>
<p>Bei 20 Zehn- bis Vierzehnjährigen sind 1-zu-1-Verbindungen mit Bluetooth oder Kabel nicht so richtig praktisch. Internetbasierte Lösungen waren aus verschiedenen Gründen ebenfalls nicht das Richtige. Also habe ich angeboten, eine kleine Eigenbau-Lösung zu basteln.</p>
<p>Das Konzept: Wir stellen einen WLAN-Router auf, mit dem sich alle verbinden. Er braucht keinen Internet-Uplink. Die Projektleiterin startet einen Node.js-Webserver auf ihrem Macbook, der eine Seite mit einem Webformular ausliefert, das nichts anderes tut, als einen Datei-Upload zu ermöglichen. Der Server speichert die hochgeladenen Files auf dem Laptop und das wars. </p>
<h3 id="Schritt-0-Init"><a href="#Schritt-0-Init" class="headerlink" title="Schritt 0: Init"></a>Schritt 0: Init</h3><pre><code>$ mkdir -p upload-app/server &amp;&amp; cd upload-app
</code></pre><p>Wir initialisieren das Projekt und installieren das erste Paket:</p>
<pre><code>$ yarn init -y
$ yarn add express
</code></pre><h3 id="Schritt-1-Der-Server"><a href="#Schritt-1-Der-Server" class="headerlink" title="Schritt 1: Der Server"></a>Schritt 1: Der Server</h3><p>Als erstes erstellen wir die Datei <code>server/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Für CSS und ggfs. JS</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'static'</span>)));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'Hello\n'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Listening on port 3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Sehr schön. Um uns das Entwicklerleben leichter zu machen, installieren wir uns <code>nodemon</code> und starten dann per npm-Script den Server:</p>
<pre><code>$ yarn add -D nodemon
</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">&#123;</span><br><span class="line">  "name": "upload-app",</span><br><span class="line">  "version": "1.0.0",</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "start": "nodemon ./server/index.js"</span><br><span class="line">  &#125;,</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>$ npm start
Listening on port 3000
</code></pre><h3 id="Schritt-2-Die-Startseite"><a href="#Schritt-2-Die-Startseite" class="headerlink" title="Schritt 2: Die Startseite"></a>Schritt 2: Die Startseite</h3><p>Bisher antwortet unser Server nur mit dem String <code>&#39;Hello&#39;</code>. Wir ändern das mit einem schicken Low-Budget-Template. Wir erstellen die Datei <code>server/templates.js</code> mit folgendem Inhalt:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/templates.js </span></span><br><span class="line"><span class="keyword">const</span> pageHeader = <span class="string">`&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset="utf-8" /&gt;</span><br><span class="line">    &lt;meta name="viewport" content="width=device-width" /&gt;</span><br><span class="line">    &lt;title&gt;Du und die Kamera – KKS&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;div class="wrapper"&gt;</span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pageFooter = <span class="string">`    &lt;/div&gt;</span><br><span class="line">    &lt;script src="/upload.js" /&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homepage = () =&gt; <span class="string">`<span class="subst">$&#123;pageHeader&#125;</span></span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line"><span class="subst">$&#123;pageFooter&#125;</span></span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  homepage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Wir exportieren also eine Funktion, die ein Template-Literal zurückgibt. Wir hätten Header und Footer auch direkt integrieren können, aber wir brauchen sie später noch für eine zweite Seite.</p>
<p>In <code>server/index.js</code> nutzen wir jetzt die <code>homepage</code>-Funktion:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/index.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; homepage &#125; = <span class="built_in">require</span>(<span class="string">'./templates.js'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(homepage());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Wir haben jetzt ein Formular mit einem File-Upload-Input auf unserer Website. Es sieht noch ein bisschen unspektakulär aus. Werfen wir etwas CSS dagegen! Wir erstellen die Datei <code>server/static/style.min.css</code>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* server/static/style.min.css */</span> </span><br><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: sans-serif;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.wrapper</span> &gt; <span class="selector-tag">form</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">20em</span>;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: auto;</span><br><span class="line">  <span class="attribute">margin-right</span>: auto;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#upload</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>:none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[for="upload"]</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">18em</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">2em</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: .<span class="number">2em</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">  <span class="attribute">background-color</span>: deepskyblue;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Besser. <em>Anmerkung:</em> Ich blende hier das eigentliche Input-Element aus und nutze die Tatsache, dass man auch auf dass zugehörige Label-Element klicken kann, um den Datei-Auswahl-Dialog zu öffnen. Diese Idee habe ich mir aus dem MDN abgeguckt: <a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Using_a_label_element_to_trigger_a_hidden_file_input_element">Using a label element to trigger a hidden file input element</a>. Das hat den Vorteil, dass man das hässliche Browser-gestylte File-Input los ist und in Ruhe einfach das Label stylen kann.</p>
<h3 id="Schritt-3-Datei-Uploads-annehmen"><a href="#Schritt-3-Datei-Uploads-annehmen" class="headerlink" title="Schritt 3: Datei-Uploads annehmen"></a>Schritt 3: Datei-Uploads annehmen</h3><p>Jetzt sollten wir dafür sorgen, dass der <code>/upload</code> Pfad auch in der Express-App definiert ist und die hochgeladenen Files gespeichtert werden.</p>
<p>Wir benutzen dafür <code>multiparty</code>:</p>
<pre><code>$ yarn add multiparty
</code></pre><p>und passen zuerst unseren Server an:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> handleUpload = <span class="built_in">require</span>(<span class="string">'./handleUpload.js'</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/upload'</span>, handleUpload);</span><br></pre></td></tr></table></figure>
<p>Die Datei <code>server/handleUpload.js</code> müssen wir natürlich auch schreiben:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/handleUpload.js</span></span><br><span class="line"><span class="keyword">const</span> Form = <span class="built_in">require</span>(<span class="string">'multiparty'</span>).Form;</span><br><span class="line"><span class="keyword">const</span> &#123; uploadOptions &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; successPage &#125; = <span class="built_in">require</span>(<span class="string">'./templates.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">handleUpload</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> form = <span class="keyword">new</span> Form(uploadOptions);</span><br><span class="line">  form.on(<span class="string">'file'</span>, (name, file) =&gt; &#123;</span><br><span class="line">    req.filename = file.originalFilename;</span><br><span class="line">  &#125;);</span><br><span class="line">  form.on(<span class="string">'error'</span>, () =&gt; &#123;</span><br><span class="line">  &#125;);</span><br><span class="line">  form.on(<span class="string">'close'</span>, () =&gt; res.send(successPage(req.filename)));</span><br><span class="line">  form.parse(req);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Die Instanzen von <code>multiparty.Form</code> sind Event-Emitter. <code>.parse</code> verabeitet die Anfrage vom Browser, in der die hochgeladene Datei enthalten ist. Das <code>file</code>-Event wird emittiert, wenn eine Datei aus dem Request fertig verarbeitet ist. Hier nutzen wir die Gelegenheit um den Original-Dateinamen im Request-Objekt zwischen zu speichern.</p>
<p>Die Dokumentation von multiparty rät dringend, einen Error-Listener zu registrieren, auch wenn man nichts mit dem Fehler macht. Ansonsten crasht nämlich die App bei allem, was multiparty als Error ansieht.</p>
<p>Schließlich senden wir eine Erfolgsmeldung an den Browser zurück, wenn der Request fertig verarbeitet ist. Diese <code>successPage</code> ist wieder eine Template-Funktion, die wir genau wie die Homepage in <code>server/templates.js</code> definieren:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/templates.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> successPage = filename =&gt; <span class="string">`<span class="subst">$&#123;pageHeader&#125;</span></span><br><span class="line">      &lt;p&gt;Du hast "<span class="subst">$&#123;filename&#125;</span>" erfolgreich hochgeladen.&lt;/p&gt;</span><br><span class="line"><span class="subst">$&#123;pageFooter&#125;</span></span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  homepage,</span><br><span class="line">  successPage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Hier nutzen wir den im Request-Objekt gespeicherten Dateinamen, um der Nutzerin im Browser nochmal anzuzeigen, was sie hochgeladen hat.</p>
<p>Haben alle bemerkt, dass es noch ein Detail in <code>handleUpload.js</code> zu besprechen gibt? <code>config.js</code>, richtig.</p>
<p>Der Bequemlichkeit halber legen wir die Datei <code>server/config.js</code> an, und exportieren von dort ein paar Dinge:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uploadDir = path.join(process.cwd(), <span class="string">'upload-app'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="number">80</span> : <span class="number">3000</span>,</span><br><span class="line">  uploadDir,</span><br><span class="line">  uploadOptions: &#123;</span><br><span class="line">    uploadDir,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Bisher geben wir <code>multiparty</code> nur eine Option mit, aber eventuell ändert sich das auch einmal und dann haben wir schon ein ganzes Config-Objekt dafür. Außerdem wollen wir in der Lage sein, im Produktions-Modus den allgemein gültigen HTTP-Port zu nutzen anstatt 3000. Das <code>uploadDir</code> exportieren wir gleich mit, um es bei App-Start anzulegen und zusammen mit der “Listening …”-Meldung anzuzeigen. So weiß derjenige, der den Server startet, auch direkt, wo er nach den hochgeladenen Dateien schauen muss. Wir haben es hier so eingerichtet, dass dieses Verzeichnis innerhalb des Ordners erzeugt wird, aus dem die App gestartet wird. Das ganze wird von unserem Server so genutzt:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; port, uploadDir &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  fs.mkdirSync(uploadDir);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="comment">// Wenn das Verzeichnis schon existiert, machen wir einfach weiter.</span></span><br><span class="line">  <span class="comment">// Bei jedem anderen Fehler lassen wir crashen.</span></span><br><span class="line">  <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br><span class="line">app.listen(port, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">Listening on port <span class="subst">$&#123;port&#125;</span></span><br><span class="line">Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">  `</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Damit sind wir eigentlich fertig. Wir haben eine Website, man kann dort eine Bild-Datei hochladen, sie landet in unserem Upload-Ordner und man bekommt eine Bestätigung nach dem Hochladen.</p>
<h3 id="Schritt-4-Es-geht-besser"><a href="#Schritt-4-Es-geht-besser" class="headerlink" title="Schritt 4: Es geht besser"></a>Schritt 4: Es geht besser</h3><p>Es bleibt allerdings die Frage offen: Woher wissen denn alle Beteiligten, was sie in die Adresszeile ihres Smartphone-Browsers eingeben müssen, um zu unserer schicken Upload-App zu kommen?</p>
<p>Per default lauscht Express auf allen zugewiesenen IP-Adressen. Wenn wir wüssten, welche IP der Computer, auf dem der Server läuft, vom WLAN-Accesspoint bekommen hat, könnten wir das allen sagen. Wir wollen die Kursleiterin aber nicht dazu verdonnern in ihren Netzwerkeinstellungen irgendwo in den Untiefen des Computers danach zu suchen. Es wäre doch schon mal viel netter, wenn wir die richtige (also erreichbare) IP einfach direkt beim App-Start im Terminal ausgeben. Dann könnte zumindest die Kursleiterin allen die Addresse sagen.</p>
<p>Ok, los gehts. Wir brauchen eine IP-Adresse, die nicht intern ist (intern wäre z.B. 127.0.0.1, die zeigt immer auf den Rechner, auf dem sie angefragt wird). Dann stellen wir sicher, dass der Server auf dieser Adresse lauscht und zeigen sie im Terminal an:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/config.js</span></span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getMachineIp = () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ifs = os.networkInterfaces();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(ifs)</span><br><span class="line">    <span class="comment">// Accumulate all address objects from all interfaces in one array</span></span><br><span class="line">    .reduce((flattened, iface) =&gt; [...flattened, ...ifs[iface]], [])</span><br><span class="line">    <span class="comment">// Only external addresses</span></span><br><span class="line">    .filter(address =&gt; !address.internal)</span><br><span class="line">    <span class="comment">// Only v4 addresses (easier to type in a browser)</span></span><br><span class="line">    <span class="comment">// And take only the first one</span></span><br><span class="line">    .filter(address =&gt; address.family === <span class="string">'IPv4'</span>)[<span class="number">0</span>].address;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="number">80</span> : <span class="number">3000</span>,</span><br><span class="line">  uploadDir,</span><br><span class="line">  uploadOptions: &#123;</span><br><span class="line">    uploadDir,</span><br><span class="line">  &#125;,</span><br><span class="line">  serverIp: getMachineIp(),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ich empfehle jedem mal auf dem eigenen Rechner die Node.js REPL zu starten und dort <code>os.networkInterfaces()</code> aufzurufen, um einen Eindruck zu bekommen, mit was für Daten wir hier arbeiten.</p>
<p>Als nächstes bauen wir das in den Server ein:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; port, serverIp, uploadDir &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (serverIp) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.mkdirSync(uploadDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  app.listen(port, serverIp, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">  Listening on <span class="subst">$&#123;serverIp&#125;</span>:<span class="subst">$&#123;port&#125;</span></span><br><span class="line">  Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">      `</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'No public v4 IP found!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Wir können jetzt zwar unsere Website nicht mehr mit <code>localhost:3000</code> aufrufen, aber das wäre ja eh nur auf dem Computer gegangen, auf dem der Server läuft. Viel wichtiger ist, dass die Kinder sie von außen erreichen.</p>
<p>Jetzt könnte die Kursleiterin also die richtige IP-Adresse sehen und sie z.B. an die Tafel schreiben. Oder in ein Dokument tippen und das mit dem Beamer an die Wand werfen. Moment. Ein Beamer? Ein Dokument? Wir können die IP auch gleich zusätzlich auf der Upload-Webseite anzeigen. Dazu müssen wir sie bloß unserer Template-Funktion übergeben:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// in server/templates.js</span><br><span class="line">const homepage = (&#123; address, listenPort &#125;) =&gt; `$&#123;pageHeader&#125;</span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Die Adresse ist: $&#123;address&#125;$&#123;listenPort === 80 ? '' : `:$&#123;listenPort&#125;`&#125;&lt;/p&gt;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">$&#123;pageFooter&#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homepageOpts = &#123;</span><br><span class="line">  address: serverIp,</span><br><span class="line">  listenPort: port,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(homepage(homepageOpts));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Schritt-5-Und-noch-besser"><a href="#Schritt-5-Und-noch-besser" class="headerlink" title="Schritt 5: Und noch besser"></a>Schritt 5: Und noch besser</h3><p>IP-Adressen sind trotzdem ganz schön nervig einzutippen, erst recht auf einem Smartphone. Also machen wir noch eine Verbesserung: Einen QR-Code! </p>
<pre><code>$ yarn add qrcode
</code></pre><p>Wir erzeugen jetzt beim App-Start einmalig aus der IP-Adresse und dem Port einen URL, den wir als QR-Code in Form eines Image-Data-URI encodieren. Das spart uns das abspeichern, auslesen und aufräumen einer richtigen Bild-Datei. Der Data-URI wird bei App-Start erzeugt und im RAM gehalten bis der Prozess beendet wird. Und wir können ihn einfach bei jedem Request an die Template-Funktion weiterreichen, von der er direkt in das HTML injiziert wird. Sollte aus irgendeinem Grund das Erzeugen fehlschlagen, ist uns das egal, denn die IP wird als Fallback auch noch angezeigt.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> qrcode = <span class="built_in">require</span>(<span class="string">'qrcode'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  homepageOpts.qr = app.locals.qr;</span><br><span class="line">  res.send(homepage(homepageOpts));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (serverIp) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.mkdirSync(uploadDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> location = <span class="string">`<span class="subst">$&#123;serverIp&#125;</span><span class="subst">$&#123;port === '80' ? '' : `:$&#123;port&#125;</span>`</span>&#125;<span class="string">`;</span><br><span class="line">  qrcode.toDataURI(`</span>http:<span class="comment">//$&#123;location&#125;`, &#123; scale: 8 &#125;, (error, uri) =&gt; &#123;</span></span><br><span class="line">    app.locals.qr = uri;</span><br><span class="line">    app.listen(port, serverIp, (err) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-console</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">  Listening on <span class="subst">$&#123;serverIp&#125;</span>:<span class="subst">$&#123;port&#125;</span></span><br><span class="line">  Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">      `</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'No public v4 IP found!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// in server/templates.js</span><br><span class="line">const homepage = (&#123; address, listenPort, qr &#125;) =&gt; `$&#123;pageHeader&#125;</span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Die Adresse ist: $&#123;address&#125;$&#123;listenPort === 80 ? '' : `:$&#123;listenPort&#125;`&#125;&lt;/p&gt;</span><br><span class="line">        $&#123;qr ? `&lt;p&gt;&lt;img src="$&#123;qr&#125;" /&gt;&lt;/p&gt;` : ''&#125;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">$&#123;pageFooter&#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<p>So, jetzt sind wir aber wirklich fertig. Übrigens ganz ohne Client-Side-Javascript. Wir brauchten gerade mal zwei Dependencies: <code>express</code> und <code>multiparty</code>. Eine dritte, <code>qrcode</code>, um den Bequemlichkeitsfaktor noch zu erhöhen. Das ganze läuft unter Node.js 6.9.5, ohne Babel, ohne Webpack, ohne React, sogar ganz ohne externe Templating-Engine.</p>
<p>Was noch schön wäre, weil wir ja das File-Input-Element kaputtgemacht haben, mit ein bisschen Browser-Javascript das zum Upload ausgewählte Bild anzuzeigen. Entweder als schnöden Dateinamen oder sogar als Thumbnail. Ideen dazu gibt es <a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">hier</a>.</p>
<p>Außerdem wollen wir eher ungern die Kursleiterin dazu zwingen, sich Node.js zu installieren, <code>npm install</code> zu machen und so weiter. Daher bietet sich ein Packager wie <code>pkg</code> von zeit an.</p>

	</div>
</article>

	
		<article id="node-js-performance-socket-hangup" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2016/04/node-js-performance-socket-hangup/">
	
		<h2 class="blog-post-title">Node.js Performance und socket hangup</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2016-04-09T16:45:00.000Z">09. April 2016</time></p>
	</header>
	<div class="blog-post-content">
		<p>In dem Team bei einer großen deutschen Internetfirma, in dem ich gerade arbeite, haben wir ein bisher eher unerklärliches Problem, das in unseren Logfiles aufschlägt.</p>
<p>Wir haben dort eine Express-basierte Webapp, die den Content im Grunde vollständig auf dem Server rendert. Dafür werden unter anderem diverse Microservices angesprochen, d.h. bei jedem Request an die Express-App fragt diese per AJAX mehrere interne, separate Dienste nach Daten und rendert basierend auf deren Antworten den Content, der an den Client gesendet wird.</p>
<p>Das funkioniert auch ziemlich gut, allerdings haben wir in den Logfiles unserer App ungewöhnlich viele “ERROR: socket hang up”-Meldungen. Nicht so viele, dass wir ernsthafte Schwierigkeiten hätten, die auch sichtbar wären, aber, und das ist besonders interessant, es sind wesentlich mehr als bei anderen Webapps, die Java-basiert sind und dieselben Services bei jedem Request anfragen.</p>
<p>Es scheint also primär nichts mit den internen Services zu tun zu haben, sondern mit unserer Node-App. Bisher haben wir nicht so wirklich eine Idee, was es sein könnte. Für die AJAX-calls nutzen wir <a href="https://github.com/mzabriskie/axios">Axios</a> und definieren damit auch ein Timeout, das bei 60ms liegt. Das kann es allerdings nicht sein, denn dann sähen wir timeout-Errors und nicht Socket-hang-ups. </p>
<p>Also habe ich mal das Internet danach durchforstet, was diese Socket-hangups bei Node erzeugen könnte. Dabei bin ich auf einen interessanten <a href="http://www.murvinlai.com/remote-http-request.html">Blogpost</a> gestoßen. Dort wird beschrieben, dass solche Fehler zwar auch von der Remote-Seite kommen können, aber eben auch von den Limitierungen des Systems, auf dem der Node-Server läuft. Es gibt ein Limit für die Zahl der gleichzeitig offenen Files, wobei dieses Limit pro Login=User gilt. Der Standardwert ist 1024. Ein Socket ist wie alles auf unixoiden Systemen eine Datei. Ein User (in dem Fall der User, dem der Node-Prozess gehört), kann also maximal 1024 Dateien gleichzeitig öffnen.</p>
<p>Das wäre auf jeden Fall mal ein Ansatz. Der Verfasser des erwähnten Blogartikels empfiehlt ein Limit von 10240, also das Zehnfache. Außerdem sollte der maxSockets-Wert des http.Agents von Node auf eine Zahl knapp unter dem ulimit gesetzt werden. Nodes Standard für maxSockets ist (mittlerweile) <code>Infinity</code>, aber bei uns ist es derzeit auf 25 gesetzt. Ich muss noch mal nachforschen, was der Grund für dieses Limit war. </p>
<p>Ohne dass ich weiß, wie unsere Java-Apps funktionieren oder konfiguriert sind, gefällt mir der Gedanke, dass unsere Node.js-App ankommende Anfragen so schnell verarbeitet und dementsprechend oft parallel die Services anspricht, dass es an Systemlimits stößt, die von den Java-Kreuzern nie tangiert werden.</p>
<p>Schauen wir mal.</p>

	</div>
</article>

	

</div>

		</main>
	<footer class="site-footer h-card" aria-describedby="dse">
		<h3 class="in-site-footer cta">Kontaktieren Sie mich</h3>
		<p class="in-site-footer">Email: <a href="mailto:contact@tobias-barth.net" rel="me" class="u-email">contact@tobias-barth.net</a><br />
		Telefon: <a href="tel:+4915111215929">+49 151 112 15 929</a></p>
		<p id="dse" class="in-site-footer">(Bitte beachten Sie vor der Kontaktaufnahme meine Datenschutzerklärung.)</p>
		<h3 class="in-site-footer cta">Finden Sie mich</h3>
		<p class="in-site-footer"><img class="sm u-photo" src="/images/Portrait.png" alt="Mein Avatar" /><a class="sm fa fa-adn" href="https://alpha.app.net/4nduril" rel="me"><span>App.net</span></a> <a class="sm fa fa-twitter" href="https://twitter.com/4nduril" rel="me"><span>Twitter</span></a> <a class="sm fa fa-github-square" href="https://github.com/4nduril" rel="me"><span>Github</span></a></p>
		<h3 class="in-site-footer">Impressum</h3>
		<p class="in-site-footer">Inhaltlich verantwortlich gemäß § 5 <abbr title="Telemediengesetz">TMG</abbr>:<br />
		<a href="http://tobias-barth.net" class="p-name u-url">Tobias&nbsp;Barth</a><br />
		<span class="p-street-address">Vincenzstr.&nbsp;25</span><br />
		<span class="p-locality p-postal-code">51065&nbsp;Köln</span></p>
		<p class="in-site-footer">USt-ID: DE304359556</p>
		<h4 class="in-site-footer">Fotos</h4>
		<p class="in-site-footer">&copy;&nbsp;<a href="http://annebarth.de">Anne&nbsp;Barth</a></p>
		<p class="in-site-footer"><a href="dse.html">Datenschutzerklärung</a></p>
	</footer>
</body>

</html>
