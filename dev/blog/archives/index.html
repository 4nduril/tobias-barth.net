<!DOCTYPE html>
<html lang="de">
<head>
	<meta charset="utf-8" />
	<title>tobias-barth.net | Modernes Webdesign aus Köln</title>
	<meta name="description" content="" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/css/style.css" />
	<!--[if lt IE 9]>
		<link rel="stylesheet" href="/css/old-ie.css" />
	<![endif]-->

	<!--[if lt IE 9]>
		<script src="/js/old-ie.js"></script>
	<![endif]-->
	<script type="text/javascript">
	  WebFontConfig = {
		google: { families: [ 'Dosis:300:latin', 'PT+Sans:400,400italic,700:latin' ] }
	  };
	  (function() {
		var wf = document.createElement('script');
		wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
		  '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
		wf.type = 'text/javascript';
		wf.async = 'true';
		var s = document.getElementsByTagName('script')[0];
		s.parentNode.insertBefore(wf, s);
	  })(); </script>
	<link rel="alternate" type="application/rss+xml" href="/blog/feed/rss.xml" />

</head>
<body>
	<header class="site-head">
			<a href="/"><h1 class="in-site-head">tobias-barth.net</h1>
			<p class="tagline in-site-head">Modernes Webdesign aus Köln</p></a>
		</header>


		<main>
			<nav class="main-navi" id="main-navi">
				<ul>
					<li><a href="/portfolio" title="Meine Fähigkeiten, Arbeitsfelder und Beispielprojekte"><span class="fa fa-wrench"></span> Ich mache</a></li>
				<li><a href="/blog" title="Mein Blog über Webentwicklung und Ähnliches"><span class="fa fa-pencil"></span> Ich schreibe</a></li>
<!--					<li><a href="" title="Lernen Sie mich besser kennen"><span class="fa fa-user"></span> Ich bin</a></li>-->
				</ul>
			</nav>
		<div class="blog-textcontainer">

	
		<article id="Ezjail-und-IPv6-alias-Adressen" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2017/07/Ezjail-und-IPv6-alias-Adressen/">
	
		<h2 class="blog-post-title">Ezjail und IPv6 alias Adressen</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2017-07-01T09:39:12.000Z">01. Juli 2017</time></p>
	</header>
	<div class="blog-post-content">
		<p>Ich habe vor Kurzem begonnen Jails in FreeBSD zu nutzen und auszuprobieren. Mein Digitalocean-Droplet läuft unter FreeBSD 11 und DO gibt mir eine public v4 IP-Adresse und ein <code>/124</code> v6 Präfix. Für meinen privaten Kram interessiert mich IPv4 nicht, daher habe ich 16 öffentliche IPs, mit denen ich spielen kann.</p>
<p>Das heißt, ich brauche kein NAT sondern kann den Jails direkt public IPs zuweisen, die ich als Aliases auf das Interface lege.</p>
<p>Bisher habe ich mit <code>ezjail</code> zwei Jails eingrichtet: <code>git</code> und <code>backup</code>. DO weißt dem Interface automatisch die v6-IP mit der Endziffer <code>1</code> zu. In meiner <code>rc.conf</code> steht entsprechend für die beiden Jail-IPs:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ifconfig_vtnet0_alias1</span>=<span class="string">"inet6 xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx2 prefixlen 64"</span></span><br><span class="line"><span class="attr">ifconfig_vtnet0_alias2</span>=<span class="string">"inet6 xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx3 prefixlen 64"</span></span><br><span class="line"><span class="attr">cloned_interfaces</span>=<span class="string">"lo1"</span></span><br><span class="line"><span class="attr">ezjail_enable</span>=<span class="string">"YES"</span></span><br></pre></td></tr></table></figure>
<p>Heute musste ich das Droplet powercyclen und beim Boot kam nur der <code>git</code>-Jail hoch. Ich probierte, den zweiten selbst zu starten:</p>
<pre><code># ezjail-admin start backup
</code></pre><p>Das gab diesen Fehler aus:</p>
<pre><code>ifconfig: ioctl (SIOCAIFADDR): Invalid argument)
</code></pre><p>Erst wusste ich damit nichts anzufangen. Dann fiel mir auf, dass in der Zeile davor der Befehl stand, der versucht wurde auszuführen:</p>
<pre><code>/usr/sbin/ifconfig vtnet0 inet6 &lt;adresse&gt;/128 alias
</code></pre><p>Hoppala. <code>ezjail</code> versuchte selbst einen Alias anzulegen, obwohl schon einer existiert. Tatsächlich habe ich dann nochmal selbst den <code>ifconfig</code> Befehl getestet, geht tatsächlich nicht.</p>
<p>Ist auch klar: Mit dieser IP war bereits ein Alias definiert <em>mit der Präfixlänge 64</em>. Hier wurde versucht ein Alias für dieselbe IP anzulegen, <em>aber mit der Präfixlänge 128</em>, was natürlich nicht geht.</p>
<p>Ein Blick in die <code>ezjail</code>-Config-files für die beiden Jails zeigt, dass ich bei dem <code>git</code>-Jail die IP so konfiguriert habe:</p>
<pre><code>export jail_git_ip=&quot;xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx2&quot;
</code></pre><p>Bei dem <code>backup</code>-Jail brauchte ich aber wegen eines Dienstes darin ein Loopback-Interface, das ich in der <code>rc.conf</code> oben als <code>lo1</code> angelegt habe. Also muss ich dem Jail zwei Interfaces mit IPs übergeben und das mache ich so:</p>
<pre><code>export jail_git_ip=&quot;lo1|127.0.0.3,vtnet0|xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx3&quot;
</code></pre><p>Offenbar führt die fehlende Präfixlängenangabe hier dazu, dass <code>ezjail</code> (oder <code>ifconfig</code>) sie auf 128 setzt. Also änderte ich die Zeile zu: </p>
<pre><code>export jail_git_ip=&quot;lo1|127.0.0.3,vtnet0|xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxxx:xxx3/64&quot;
</code></pre><p>Und schon läuft es.</p>

	</div>
</article>

	
		<article id="Einfache-Foto-Upload-App-mit-Node-js" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2017/05/Einfache-Foto-Upload-App-mit-Node-js/">
	
		<h2 class="blog-post-title">Einfache Foto-Upload-App mit Node.js</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2017-05-30T17:08:00.000Z">30. Mai 2017</time></p>
	</header>
	<div class="blog-post-content">
		<p>Meine Frau brauchte für ein Projekt mit Kindern eine einfache Möglichkeit, Fotos von Smartphones auf ihren Laptop zu laden. Es gibt viele Methoden das zu machen: Bluetooth, USB, SD-Karten-Austausch, und natürlich die üblichen Internet-Lösungen wie Dropbox.</p>
<p>Bei 20 Zehn- bis Vierzehnjährigen sind 1-zu-1-Verbindungen mit Bluetooth oder Kabel nicht so richtig praktisch. Internetbasierte Lösungen waren aus verschiedenen Gründen ebenfalls nicht das Richtige. Also habe ich angeboten, eine kleine Eigenbau-Lösung zu basteln.</p>
<p>Das Konzept: Wir stellen einen WLAN-Router auf, mit dem sich alle verbinden. Er braucht keinen Internet-Uplink. Die Projektleiterin startet einen Node.js-Webserver auf ihrem Macbook, der eine Seite mit einem Webformular ausliefert, das nichts anderes tut, als einen Datei-Upload zu ermöglichen. Der Server speichert die hochgeladenen Files auf dem Laptop und das wars. </p>
<h3 id="Schritt-0-Init"><a href="#Schritt-0-Init" class="headerlink" title="Schritt 0: Init"></a>Schritt 0: Init</h3><pre><code>$ mkdir -p upload-app/server &amp;&amp; cd upload-app
</code></pre><p>Wir initialisieren das Projekt und installieren das erste Paket:</p>
<pre><code>$ yarn init -y
$ yarn add express
</code></pre><h3 id="Schritt-1-Der-Server"><a href="#Schritt-1-Der-Server" class="headerlink" title="Schritt 1: Der Server"></a>Schritt 1: Der Server</h3><p>Als erstes erstellen wir die Datei <code>server/index.js</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Für CSS und ggfs. JS</span></span><br><span class="line">app.use(express.static(path.join(__dirname, <span class="string">'static'</span>)));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">'Hello\n'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Listening on port 3000'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Sehr schön. Um uns das Entwicklerleben leichter zu machen, installieren wir uns <code>nodemon</code> und starten dann per npm-Script den Server:</p>
<pre><code>$ yarn add -D nodemon
</code></pre><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// package.json</span><br><span class="line">&#123;</span><br><span class="line">  "name": "upload-app",</span><br><span class="line">  "version": "1.0.0",</span><br><span class="line">  "scripts": &#123;</span><br><span class="line">    "start": "nodemon ./server/index.js"</span><br><span class="line">  &#125;,</span><br><span class="line">  …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<pre><code>$ npm start
Listening on port 3000
</code></pre><h3 id="Schritt-2-Die-Startseite"><a href="#Schritt-2-Die-Startseite" class="headerlink" title="Schritt 2: Die Startseite"></a>Schritt 2: Die Startseite</h3><p>Bisher antwortet unser Server nur mit dem String <code>&#39;Hello&#39;</code>. Wir ändern das mit einem schicken Low-Budget-Template. Wir erstellen die Datei <code>server/templates.js</code> mit folgendem Inhalt:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/templates.js </span></span><br><span class="line"><span class="keyword">const</span> pageHeader = <span class="string">`&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset="utf-8" /&gt;</span><br><span class="line">    &lt;meta name="viewport" content="width=device-width" /&gt;</span><br><span class="line">    &lt;title&gt;Du und die Kamera – KKS&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;div class="wrapper"&gt;</span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pageFooter = <span class="string">`    &lt;/div&gt;</span><br><span class="line">    &lt;script src="/upload.js" /&gt;</span><br><span class="line">  &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homepage = () =&gt; <span class="string">`<span class="subst">$&#123;pageHeader&#125;</span></span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line"><span class="subst">$&#123;pageFooter&#125;</span></span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  homepage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Wir exportieren also eine Funktion, die ein Template-Literal zurückgibt. Wir hätten Header und Footer auch direkt integrieren können, aber wir brauchen sie später noch für eine zweite Seite.</p>
<p>In <code>server/index.js</code> nutzen wir jetzt die <code>homepage</code>-Funktion:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/index.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; homepage &#125; = <span class="built_in">require</span>(<span class="string">'./templates.js'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(homepage());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Wir haben jetzt ein Formular mit einem File-Upload-Input auf unserer Website. Es sieht noch ein bisschen unspektakulär aus. Werfen wir etwas CSS dagegen! Wir erstellen die Datei <code>server/static/style.css</code>:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* server/static/style.css */</span> </span><br><span class="line">* &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: sans-serif;</span><br><span class="line">  <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">img</span> &#123;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.wrapper</span> &gt; <span class="selector-tag">form</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: flex;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">20em</span>;</span><br><span class="line">  <span class="attribute">max-width</span>: <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">margin-left</span>: auto;</span><br><span class="line">  <span class="attribute">margin-right</span>: auto;</span><br><span class="line">  <span class="attribute">justify-content</span>: center;</span><br><span class="line">  <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#upload</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>:none;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[for="upload"]</span> &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">18em</span>;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">margin-top</span>: <span class="number">1em</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">2em</span>;</span><br><span class="line">  <span class="attribute">border-radius</span>: .<span class="number">2em</span>;</span><br><span class="line">  <span class="attribute">text-align</span>: center;</span><br><span class="line">  <span class="attribute">color</span>: white;</span><br><span class="line">  <span class="attribute">background-color</span>: deepskyblue;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Besser. <em>Anmerkung:</em> Ich blende hier das eigentliche Input-Element aus und nutze die Tatsache, dass man auch auf dass zugehörige Label-Element klicken kann, um den Datei-Auswahl-Dialog zu öffnen. Diese Idee habe ich mir aus dem MDN abgeguckt: <a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications#Using_a_label_element_to_trigger_a_hidden_file_input_element">Using a label element to trigger a hidden file input element</a>. Das hat den Vorteil, dass man das hässliche Browser-gestylte File-Input los ist und in Ruhe einfach das Label stylen kann.</p>
<h3 id="Schritt-3-Datei-Uploads-annehmen"><a href="#Schritt-3-Datei-Uploads-annehmen" class="headerlink" title="Schritt 3: Datei-Uploads annehmen"></a>Schritt 3: Datei-Uploads annehmen</h3><p>Jetzt sollten wir dafür sorgen, dass der <code>/upload</code> Pfad auch in der Express-App definiert ist und die hochgeladenen Files gespeichtert werden.</p>
<p>Wir benutzen dafür <code>multiparty</code>:</p>
<pre><code>$ yarn add multiparty
</code></pre><p>und passen zuerst unseren Server an:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> handleUpload = <span class="built_in">require</span>(<span class="string">'./handleUpload.js'</span>);</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">'/upload'</span>, handleUpload);</span><br></pre></td></tr></table></figure>
<p>Die Datei <code>server/handleUpload.js</code> müssen wir natürlich auch schreiben:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/handleUpload.js</span></span><br><span class="line"><span class="keyword">const</span> Form = <span class="built_in">require</span>(<span class="string">'multiparty'</span>).Form;</span><br><span class="line"><span class="keyword">const</span> &#123; uploadOptions &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; successPage &#125; = <span class="built_in">require</span>(<span class="string">'./templates.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> <span class="title">handleUpload</span>(<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> form = <span class="keyword">new</span> Form(uploadOptions);</span><br><span class="line">  form.on(<span class="string">'file'</span>, (name, file) =&gt; &#123;</span><br><span class="line">    req.filename = file.originalFilename;</span><br><span class="line">  &#125;);</span><br><span class="line">  form.on(<span class="string">'error'</span>, () =&gt; &#123;</span><br><span class="line">  &#125;);</span><br><span class="line">  form.on(<span class="string">'close'</span>, () =&gt; res.send(successPage(req.filename)));</span><br><span class="line">  form.parse(req);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Die Instanzen von <code>multiparty.Form</code> sind Event-Emitter. <code>.parse</code> verabeitet die Anfrage vom Browser, in der die hochgeladene Datei enthalten ist. Das <code>file</code>-Event wird emittiert, wenn eine Datei aus dem Request fertig verarbeitet ist. Hier nutzen wir die Gelegenheit um den Original-Dateinamen im Request-Objekt zwischen zu speichern.</p>
<p>Die Dokumentation von multiparty rät dringend, einen Error-Listener zu registrieren, auch wenn man nichts mit dem Fehler macht. Ansonsten crasht nämlich die App bei allem, was multiparty als Error ansieht.</p>
<p>Schließlich senden wir eine Erfolgsmeldung an den Browser zurück, wenn der Request fertig verarbeitet ist. Diese <code>successPage</code> ist wieder eine Template-Funktion, die wir genau wie die Homepage in <code>server/templates.js</code> definieren:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/templates.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> successPage = filename =&gt; <span class="string">`<span class="subst">$&#123;pageHeader&#125;</span></span><br><span class="line">      &lt;p&gt;Du hast "<span class="subst">$&#123;filename&#125;</span>" erfolgreich hochgeladen.&lt;/p&gt;</span><br><span class="line"><span class="subst">$&#123;pageFooter&#125;</span></span><br><span class="line">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  homepage,</span><br><span class="line">  successPage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Hier nutzen wir den im Request-Objekt gespeicherten Dateinamen, um der Nutzerin im Browser nochmal anzuzeigen, was sie hochgeladen hat.</p>
<p>Haben alle bemerkt, dass es noch ein Detail in <code>handleUpload.js</code> zu besprechen gibt? <code>config.js</code>, richtig.</p>
<p>Der Bequemlichkeit halber legen wir die Datei <code>server/config.js</code> an, und exportieren von dort ein paar Dinge:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/config.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> uploadDir = path.join(process.cwd(), <span class="string">'upload-app'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="number">80</span> : <span class="number">3000</span>,</span><br><span class="line">  uploadDir,</span><br><span class="line">  uploadOptions: &#123;</span><br><span class="line">    uploadDir,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Bisher geben wir <code>multiparty</code> nur eine Option mit, aber eventuell ändert sich das auch einmal und dann haben wir schon ein ganzes Config-Objekt dafür. Außerdem wollen wir in der Lage sein, im Produktions-Modus den allgemein gültigen HTTP-Port zu nutzen anstatt 3000. Das <code>uploadDir</code> exportieren wir gleich mit, um es bei App-Start anzulegen und zusammen mit der “Listening …”-Meldung anzuzeigen. So weiß derjenige, der den Server startet, auch direkt, wo er nach den hochgeladenen Dateien schauen muss. Wir haben es hier so eingerichtet, dass dieses Verzeichnis innerhalb des Ordners erzeugt wird, aus dem die App gestartet wird. Das ganze wird von unserem Server so genutzt:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; port, uploadDir &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  fs.mkdirSync(uploadDir);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">  <span class="comment">// Wenn das Verzeichnis schon existiert, machen wir einfach weiter.</span></span><br><span class="line">  <span class="comment">// Bei jedem anderen Fehler lassen wir crashen.</span></span><br><span class="line">  <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br><span class="line">app.listen(port, (err) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">Listening on port <span class="subst">$&#123;port&#125;</span></span><br><span class="line">Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">  `</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Damit sind wir eigentlich fertig. Wir haben eine Website, man kann dort eine Bild-Datei hochladen, sie landet in unserem Upload-Ordner und man bekommt eine Bestätigung nach dem Hochladen.</p>
<h3 id="Schritt-4-Es-geht-besser"><a href="#Schritt-4-Es-geht-besser" class="headerlink" title="Schritt 4: Es geht besser"></a>Schritt 4: Es geht besser</h3><p>Es bleibt allerdings die Frage offen: Woher wissen denn alle Beteiligten, was sie in die Adresszeile ihres Smartphone-Browsers eingeben müssen, um zu unserer schicken Upload-App zu kommen?</p>
<p>Per default lauscht Express auf allen zugewiesenen IP-Adressen. Wenn wir wüssten, welche IP der Computer, auf dem der Server läuft, vom WLAN-Accesspoint bekommen hat, könnten wir das allen sagen. Wir wollen die Kursleiterin aber nicht dazu verdonnern in ihren Netzwerkeinstellungen irgendwo in den Untiefen des Computers danach zu suchen. Es wäre doch schon mal viel netter, wenn wir die richtige (also erreichbare) IP einfach direkt beim App-Start im Terminal ausgeben. Dann könnte zumindest die Kursleiterin allen die Addresse sagen.</p>
<p>Ok, los gehts. Wir brauchen eine IP-Adresse, die nicht intern ist (intern wäre z.B. 127.0.0.1, die zeigt immer auf den Rechner, auf dem sie angefragt wird). Dann stellen wir sicher, dass der Server auf dieser Adresse lauscht und zeigen sie im Terminal an:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/config.js</span></span><br><span class="line"><span class="keyword">const</span> os = <span class="built_in">require</span>(<span class="string">'os'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getMachineIp = () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> ifs = os.networkInterfaces();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Object</span>.keys(ifs)</span><br><span class="line">    <span class="comment">// Accumulate all address objects from all interfaces in one array</span></span><br><span class="line">    .reduce((flattened, iface) =&gt; [...flattened, ...ifs[iface]], [])</span><br><span class="line">    <span class="comment">// Only external addresses</span></span><br><span class="line">    .filter(address =&gt; !address.internal)</span><br><span class="line">    <span class="comment">// Only v4 addresses (easier to type in a browser)</span></span><br><span class="line">    <span class="comment">// And take only the first one</span></span><br><span class="line">    .filter(address =&gt; address.family === <span class="string">'IPv4'</span>)[<span class="number">0</span>].address;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  port: process.env.NODE_ENV === <span class="string">'production'</span> ? <span class="number">80</span> : <span class="number">3000</span>,</span><br><span class="line">  uploadDir,</span><br><span class="line">  uploadOptions: &#123;</span><br><span class="line">    uploadDir,</span><br><span class="line">  &#125;,</span><br><span class="line">  serverIp: getMachineIp(),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Ich empfehle jedem mal auf dem eigenen Rechner die Node.js REPL zu starten und dort <code>os.networkInterfaces()</code> aufzurufen, um einen Eindruck zu bekommen, mit was für Daten wir hier arbeiten.</p>
<p>Als nächstes bauen wir das in den Server ein:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; port, serverIp, uploadDir &#125; = <span class="built_in">require</span>(<span class="string">'./config.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (serverIp) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.mkdirSync(uploadDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  app.listen(port, serverIp, (err) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">  Listening on <span class="subst">$&#123;serverIp&#125;</span>:<span class="subst">$&#123;port&#125;</span></span><br><span class="line">  Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">      `</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'No public v4 IP found!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Wir können jetzt zwar unsere Website nicht mehr mit <code>localhost:3000</code> aufrufen, aber das wäre ja eh nur auf dem Computer gegangen, auf dem der Server läuft. Viel wichtiger ist, dass die Kinder sie von außen erreichen.</p>
<p>Jetzt könnte die Kursleiterin also die richtige IP-Adresse sehen und sie z.B. an die Tafel schreiben. Oder in ein Dokument tippen und das mit dem Beamer an die Wand werfen. Moment. Ein Beamer? Ein Dokument? Wir können die IP auch gleich zusätzlich auf der Upload-Webseite anzeigen. Dazu müssen wir sie bloß unserer Template-Funktion übergeben:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// in server/templates.js</span><br><span class="line">const homepage = (&#123; address, listenPort &#125;) =&gt; `$&#123;pageHeader&#125;</span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Die Adresse ist: $&#123;address&#125;$&#123;listenPort === 80 ? '' : `:$&#123;listenPort&#125;`&#125;&lt;/p&gt;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">$&#123;pageFooter&#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> homepageOpts = &#123;</span><br><span class="line">  address: serverIp,</span><br><span class="line">  listenPort: port,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  res.send(homepage(homepageOpts));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Schritt-5-Und-noch-besser"><a href="#Schritt-5-Und-noch-besser" class="headerlink" title="Schritt 5: Und noch besser"></a>Schritt 5: Und noch besser</h3><p>IP-Adressen sind trotzdem ganz schön nervig einzutippen, erst recht auf einem Smartphone. Also machen wir noch eine Verbesserung: Einen QR-Code! </p>
<pre><code>$ yarn add qrcode
</code></pre><p>Wir erzeugen jetzt beim App-Start einmalig aus der IP-Adresse und dem Port einen URL, den wir als QR-Code in Form eines Image-Data-URI encodieren. Das spart uns das abspeichern, auslesen und aufräumen einer richtigen Bild-Datei. Der Data-URI wird bei App-Start erzeugt und im RAM gehalten bis der Prozess beendet wird. Und wir können ihn einfach bei jedem Request an die Template-Funktion weiterreichen, von der er direkt in das HTML injiziert wird. Sollte aus irgendeinem Grund das Erzeugen fehlschlagen, ist uns das egal, denn die IP wird als Fallback auch noch angezeigt.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in server/index.js</span></span><br><span class="line"><span class="keyword">const</span> qrcode = <span class="built_in">require</span>(<span class="string">'qrcode'</span>);</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">  homepageOpts.qr = app.locals.qr;</span><br><span class="line">  res.send(homepage(homepageOpts));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (serverIp) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    fs.mkdirSync(uploadDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.code !== <span class="string">'EEXIST'</span>) <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> location = <span class="string">`<span class="subst">$&#123;serverIp&#125;</span><span class="subst">$&#123;port === '80' ? '' : `:$&#123;port&#125;</span>`</span>&#125;<span class="string">`;</span><br><span class="line">  qrcode.toDataURI(`</span>http:<span class="comment">//$&#123;location&#125;`, &#123; scale: 8 &#125;, (error, uri) =&gt; &#123;</span></span><br><span class="line">    app.locals.qr = uri;</span><br><span class="line">    app.listen(port, serverIp, (err) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</span><br><span class="line">      <span class="comment">// eslint-disable-next-line no-console</span></span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`</span><br><span class="line">  Listening on <span class="subst">$&#123;serverIp&#125;</span>:<span class="subst">$&#123;port&#125;</span></span><br><span class="line">  Using directory "<span class="subst">$&#123;uploadDir&#125;</span>" for uploads</span><br><span class="line">      `</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="built_in">Error</span>(<span class="string">'No public v4 IP found!'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// in server/templates.js</span><br><span class="line">const homepage = (&#123; address, listenPort, qr &#125;) =&gt; `$&#123;pageHeader&#125;</span><br><span class="line">      &lt;form action="/upload" method="post" enctype="multipart/form-data"&gt;</span><br><span class="line">        &lt;h1&gt;Du und die Kamera&lt;/h1&gt;</span><br><span class="line">        &lt;p&gt;Die Adresse ist: $&#123;address&#125;$&#123;listenPort === 80 ? '' : `:$&#123;listenPort&#125;`&#125;&lt;/p&gt;</span><br><span class="line">        $&#123;qr ? `&lt;p&gt;&lt;img src="$&#123;qr&#125;" /&gt;&lt;/p&gt;` : ''&#125;</span><br><span class="line">        &lt;label for="upload"&gt;Bild auswählen&lt;/label&gt;</span><br><span class="line">        &lt;input id="upload" type="file" name="datei" accept="image/*" /&gt;</span><br><span class="line">        &lt;button type="submit"&gt;Hochladen&lt;/button&gt;</span><br><span class="line">      &lt;/form&gt;</span><br><span class="line">$&#123;pageFooter&#125;</span><br><span class="line">`;</span><br></pre></td></tr></table></figure>
<p>So, jetzt sind wir aber wirklich fertig. Übrigens ganz ohne Client-Side-Javascript. Wir brauchten gerade mal zwei Dependencies: <code>express</code> und <code>multiparty</code>. Eine dritte, <code>qrcode</code>, um den Bequemlichkeitsfaktor noch zu erhöhen. Das ganze läuft unter Node.js 6.9.5, ohne Babel, ohne Webpack, ohne React, sogar ganz ohne externe Templating-Engine.</p>
<p>Was noch schön wäre, weil wir ja das File-Input-Element kaputtgemacht haben, mit ein bisschen Browser-Javascript das zum Upload ausgewählte Bild anzuzeigen. Entweder als schnöden Dateinamen oder sogar als Thumbnail. Ideen dazu gibt es <a href="https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications">hier</a>.</p>
<p>Außerdem wollen wir eher ungern die Kursleiterin dazu zwingen, sich Node.js zu installieren, <code>npm install</code> zu machen und so weiter. Daher bietet sich ein Packager wie <code>pkg</code> von zeit an.</p>

	</div>
</article>

	
		<article id="node-js-performance-socket-hangup" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2016/04/node-js-performance-socket-hangup/">
	
		<h2 class="blog-post-title">Node.js Performance und socket hangup</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2016-04-09T16:45:00.000Z">09. April 2016</time></p>
	</header>
	<div class="blog-post-content">
		<p>In dem Team bei einer großen deutschen Internetfirma, in dem ich gerade arbeite, haben wir ein bisher eher unerklärliches Problem, das in unseren Logfiles aufschlägt.</p>
<p>Wir haben dort eine Express-basierte Webapp, die den Content im Grunde vollständig auf dem Server rendert. Dafür werden unter anderem diverse Microservices angesprochen, d.h. bei jedem Request an die Express-App fragt diese per AJAX mehrere interne, separate Dienste nach Daten und rendert basierend auf deren Antworten den Content, der an den Client gesendet wird.</p>
<p>Das funkioniert auch ziemlich gut, allerdings haben wir in den Logfiles unserer App ungewöhnlich viele “ERROR: socket hang up”-Meldungen. Nicht so viele, dass wir ernsthafte Schwierigkeiten hätten, die auch sichtbar wären, aber, und das ist besonders interessant, es sind wesentlich mehr als bei anderen Webapps, die Java-basiert sind und dieselben Services bei jedem Request anfragen.</p>
<p>Es scheint also primär nichts mit den internen Services zu tun zu haben, sondern mit unserer Node-App. Bisher haben wir nicht so wirklich eine Idee, was es sein könnte. Für die AJAX-calls nutzen wir <a href="https://github.com/mzabriskie/axios">Axios</a> und definieren damit auch ein Timeout, das bei 60ms liegt. Das kann es allerdings nicht sein, denn dann sähen wir timeout-Errors und nicht Socket-hang-ups. </p>
<p>Also habe ich mal das Internet danach durchforstet, was diese Socket-hangups bei Node erzeugen könnte. Dabei bin ich auf einen interessanten <a href="http://www.murvinlai.com/remote-http-request.html">Blogpost</a> gestoßen. Dort wird beschrieben, dass solche Fehler zwar auch von der Remote-Seite kommen können, aber eben auch von den Limitierungen des Systems, auf dem der Node-Server läuft. Es gibt ein Limit für die Zahl der gleichzeitig offenen Files, wobei dieses Limit pro Login=User gilt. Der Standardwert ist 1024. Ein Socket ist wie alles auf unixoiden Systemen eine Datei. Ein User (in dem Fall der User, dem der Node-Prozess gehört), kann also maximal 1024 Dateien gleichzeitig öffnen.</p>
<p>Das wäre auf jeden Fall mal ein Ansatz. Der Verfasser des erwähnten Blogartikels empfiehlt ein Limit von 10240, also das Zehnfache. Außerdem sollte der maxSockets-Wert des http.Agents von Node auf eine Zahl knapp unter dem ulimit gesetzt werden. Nodes Standard für maxSockets ist (mittlerweile) <code>Infinity</code>, aber bei uns ist es derzeit auf 25 gesetzt. Ich muss noch mal nachforschen, was der Grund für dieses Limit war. </p>
<p>Ohne dass ich weiß, wie unsere Java-Apps funktionieren oder konfiguriert sind, gefällt mir der Gedanke, dass unsere Node.js-App ankommende Anfragen so schnell verarbeitet und dementsprechend oft parallel die Services anspricht, dass es an Systemlimits stößt, die von den Java-Kreuzern nie tangiert werden.</p>
<p>Schauen wir mal.</p>

	</div>
</article>

	
		<article id="Mein-Blog" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2015/07/Mein-Blog/">
	
		<h2 class="blog-post-title">Mein Blog</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2015-07-25T00:24:16.000Z">25. Juli 2015</time></p>
	</header>
	<div class="blog-post-content">
		<p>Endlich habe ich es doch geschafft. Mein Blog ist funktionsfähig und online.</p>
<p>Ich hatte ja schon im zugehörigen <a href="https://github.com/4nduril/my-website/issues/5">Github-Issue</a> geschrieben, dass ich mich für das <a href="https://hexo.io">Hexo-Framework</a> entschieden hatte. Ich fand es spannend, ein bisschen ungewöhnlich und natürlich toll, dass es in Nodejs geschrieben ist. So kann ich schnell Dinge ändern bzw. fixen, die mich stören.</p>
<p>Das erste habe ich schon gefixt, nämlich das hexo-generator-feed-Plugin. Das erzeugte in meiner Konfiguration (also Hexo-Blog in Unterordner) falsche Permalinks. Ich habe den Autor zwar unter dem betreffenden Commit gefragt, wofür der war (er hat es kaputt geändert), aber bisher keine Antwort. Ich werd’s wohl demnächst auch mal als Bug oder gleich als Pull Request filen. Die reparierte Version findet man zur Zeit bei mir: <a href="https://github.com/4nduril/hexo-generator-feed">4ndurils hexo-generator-feed</a>.</p>
<p>Ich habe zwar schon länger ein privates Blog gehabt, in dem auch hin und wieder Web-Kram landete, aber ich wollte jetzt gern im richtigen Rahmen und öfter Sachen aus dem Frontend-Alltag (oder Säuremiene, wie manche sagen) posten. Zwei, drei alte Posts vom anderen Blog habe ich hier der Vollständigkeit halber importiert, aber die sind wirklich schon betagt.</p>
<p>Achso, zwei Dinge noch:</p>
<ol>
<li>Das hier ist nur die minimalist working version. Es gibt z.B. noch keine vernünftige Integration von Kategorien und Tags (sie werden zumindest noch nicht dargestellt). Das wird sich über die Zeit aber immer weiter verbessern. Die Grundfunktion eines Blogs sind Einträge und der Feed. Beides geht.</li>
<li>Es gibt keine Kommentarsektion. Das ist auch Absicht und wird erstmal so bleiben. Ob ich meine Meinung ändere, weiß ich noch nicht, derzeit steht sie aber fest. Kommentare und Anmerkungen erhalte ich aber trotzdem sehr gern per Twitter oder Email.</li>
</ol>
<p>Viel Spaß. Ich freu mich!</p>

	</div>
</article>

	
		<article id="Vererbung-von-viewport-percentage-lengths-in-Chrome" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2013/06/Vererbung-von-viewport-percentage-lengths-in-Chrome/">
	
		<h2 class="blog-post-title">Vererbung von viewport-percentage lengths in Chrome</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2013-06-05T14:59:00.000Z">05. Juni 2013</time></p>
	</header>
	<div class="blog-post-content">
		<p>Ich stolperte neulich über ein Problem mit <a href="http://www.w3.org/TR/css3-values/#viewport-relative-lengths">viewport-relativen Längen</a> in CSS. Die Situation war konkret folgende:</p>
<p>Ich hatte eine ungeordnete Liste, deren Elemente je ein <code>&lt;div&gt;</code> enthielten, in dem sich wiederum ein <code>&lt;a&gt;</code> befand:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Zuerst ein Beispiel, wie es funktionieren sollte. Die <code>&lt;li&gt;</code>-Elemente sollen eine definierte Höhe haben und die <code>&lt;div&gt;</code>s sollten genauso hoch sein. Das CSS dazu:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">* &#123; <span class="attribute">margin</span>:<span class="number">0</span>; <span class="attribute">padding</span>:<span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-tag">ul</span> &#123; <span class="attribute">list-style-type</span>:none; &#125;</span><br><span class="line"><span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>:blue;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">10em</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>:red;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">100%</span>; <span class="comment">/* Genau so hoch wie sein Container */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://jsfiddle.net/PgTZ2/2/">Hier ist ein JS-Fiddle dazu</a>. Wie erwartet bedeckt das rote <code>&lt;div&gt;</code> das gesamte Listenelement. Ruhig auch mal in verschiedenen Browsern ansehen.</p>
<p>Jetzt geben wir dem <code>&lt;li&gt;</code>-Element aber eine vom Viewport abhängige Größe:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>:<span class="number">30vw</span>; <span class="comment">/* Die Höhe soll 30 Prozent der Breite des Viewports betragen */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://jsfiddle.net/PgTZ2/3/">Hier die geänderte Demo</a>.</p>
<p>Im Firefox sieht es immer noch genau so aus wie vorher. Das würde man (ich) auch erwarten. Schließlich hat das Listenelement eine definierte Größe und ich sage, dass sein direktes Kindelement 100% dieser Größe haben soll. Sieht man sich das Ergebnis in Chrome an, zeigt sich aber ein anderes Bild.</p>
<p>Das <code>&lt;li&gt;</code> hat zwar die richtige Größe, aber das <code>&lt;div&gt;</code> ist nur so hoch, wie es sein Inhalt (eine Textzeile) erfordert. Sogar im IE9 wird es korrekt (wie im FF) dargestellt. Opera unterstützt derzeit keine viewport-related lengths, aber da auch dort <a href="http://business.opera.com/press/releases/general/opera-gears-up-at-300-million-users">demnächst ein Webkit rendert</a>, wird es sich wohl auch nur mittelmäßig zum Guten ändern.</p>
<p>Anscheinend muss man derzeit also entweder für Chrome in solchen Fällen auch jedem Kindelement die <code>v*</code>-Größe zuweisen, oder mit anderen Längeneinheiten arbeiten. Schade.</p>

	</div>
</article>

	
		<article id="jQuerys-scrollTop-und-border-box" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2013/01/jQuerys-scrollTop-und-border-box/">
	
		<h2 class="blog-post-title">jQuerys scrollTop() und border-box</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2013-01-28T21:01:00.000Z">28. Januar 2013</time></p>
	</header>
	<div class="blog-post-content">
		<p><strong>Das Folgende betrifft soweit ich sehe nur jQuery &lt; 1.8.</strong></p>
<p>Letzte Woche habe ich den ersten Kandidaten für den irrsten Bug in diesem Jahr gefunden.</p>
<p>Der Fehler, den der Kunde berichtete, beruhte darauf, dass das ursprünglich verwendete <code>$(document).scrollTop()</code> nicht im IE8 funktionierte und nachdem er dies durch das funktionierende <code>$(&#39;html&#39;).scrollTop()</code> ersetzt hatte, lief es nicht mehr in Webkit-Browsern.</p>
<p>Die Lösung dafür war relativ schnell gefunden: Ich ersetzte einfach in dem betreffenden Script den einen <code>scrollTop()</code>-Aufruf durch den Ausdruck <code>($(document).scrollTop() || $(&#39;html&#39;).scrollTop())</code>. Damit war der Drops gelutscht und jeder Browser konnte sich aussuchen, was ihm passte (bzw. was nicht gleich 0 war, da der Code nur beim Scrollen zur Anwendung kam, reichte das aus).</p>
<p>Aber was war die Ursache? Nach viel Ausprobieren blieb mir nichts übrig als in die jQuery-Source zu schauen und mir anzusehen, wie jQuery.scrollTop() definiert ist. Für das verwendete jQuery 1.6.4 sieht das so aus:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create scrollLeft and scrollTop methods</span></span><br><span class="line">jQuery.each( [<span class="string">"Left"</span>, <span class="string">"Top"</span>], <span class="function"><span class="keyword">function</span>(<span class="params"> i, name </span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> method = <span class="string">"scroll"</span> + name;</span><br><span class="line"></span><br><span class="line">  jQuery.fn[ method ] = <span class="function"><span class="keyword">function</span>(<span class="params"> val </span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> elem, win;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( val === <span class="literal">undefined</span> ) &#123;</span><br><span class="line">      elem = <span class="keyword">this</span>[ <span class="number">0</span> ];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( !elem ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      win = getWindow( elem );</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Return the scroll offset</span></span><br><span class="line">      <span class="keyword">return</span> win ? (<span class="string">"pageXOffset"</span> <span class="keyword">in</span> win) ? win[ i ? <span class="string">"pageYOffset"</span> : <span class="string">"pageXOffset"</span> ] :</span><br><span class="line">      jQuery.support.boxModel &amp;amp;&amp;amp; win.document.documentElement[ method ] ||</span><br><span class="line">      win.document.body[ method ] :</span><br><span class="line">      elem[ method ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the scroll offset</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Interessiert uns hier nicht</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>Der Fall des IE8 sollte mit der Zeile abgedeckt werden, die mit <code>jQuery.support.boxModel</code> beginnt. Diese Eigenschaft dient eigentlich dazu, zu überprüfen, ob das W3C-Box-Modell vom Browser unterstützt wird. Das Problem ist, in diesem Fall gibt sie <code>false</code> zurück, obwohl das Dokument in Ordnung ist und der Browser sich im Standardmodus befindet. Warum? Also nachsehen, wie <code>jQuery.support.boxModel</code> gesetzt wird:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Figure out if the W3C box model works as expected</span></span><br><span class="line">div.style.width = div.style.paddingLeft = <span class="string">"1px"</span>;</span><br><span class="line">support.boxModel = div.offsetWidth === <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<p>Es wird ein Test-Div erzeugt, dem verschiedene Eigenschaften zugewiesen und das dann an den <code>body</code> angehängt wird. Da das Element hier einen Pixel breit ist und außerdem ein Padding von einem Pixel erhält, sollte <code>offsetWidth</code>, das die Gesamtbreite enthält, 2px zurückgeben.</p>
<p>Tut es aber nicht.</p>
<p>Der Grund dafür ist, dass ich im CSS <code>box-sizing: border-box;</code> gesetzt habe. Das ist eigentlich eine prima Sache, denn dadurch sind Elemente, denen man eine bestimmte Breite zuweist, auch wirklich so breit &ndash; egal ob sie Innenabstände oder Rahmen enthalten. Aber in diesem Fall passiert dann folgendes: Wir geben einem Element den linken Innenabstand 1px und sagen dann, dass das gesamte Element, mit Innenabständen und Rahmen, 1px breit sein soll. Das bedeutet, für den eigentlichen Inhalt ist kein Platz mehr, was egal ist, weil das Element sowieso keinen Inhalt hat und nur zum Testen da ist. Aber das bedeutet auch, dass <code>offsetWidth</code> nun auch 1 enthält, das ist schließlich die Gesamtbreite des Elements. Damit schlägt der Test <code>div.offsetWidth === 2</code> natürlich fehl, und <code>scrollTop()</code> gibt nicht mehr <code>window.document.documentElement.scrollTop</code> zurück, sondern 0.</p>
<p>Darauf muss man erstmal kommen</p>
<p>Ab jQuery 1.8 besteht das Problem nicht mehr, weil dann nicht mehr auf Box-Model-Support getestet wird bzw. dieser Test nicht mehr in <code>scrollTop()</code> abgerufen wird.</p>
<p>Warum Webkit übrigens <code>$(&#39;html&#39;).scrollTop()</code> nicht versteht, ist mir noch nicht so ganz klar.</p>

	</div>
</article>

	
		<article id="-htaccess-Spielereien" class="blog-post">
	<header class="blog-post-header">
	
	<a class="blog-post-title-link" href="/blog/2011/12/-htaccess-Spielereien/">
	
		<h2 class="blog-post-title">.htaccess-Spielereien</h2>
	
	</a>
	
	<p class="blog-post-date">Geschrieben am <time datetime="2011-12-04T12:47:00.000Z">04. Dezember 2011</time></p>
	</header>
	<div class="blog-post-content">
		<p>Mit .htaccess-Dateien kann man den Zugang zu den einzelnen Dateien oder Dokumenten auf seinem (Apache-)Webserver sehr bequem regeln. Es lassen sich zum Beispiel einzelne Verzeichnisse nur für Nutzer mit einer bestimmten IP freigeben. Oder man kann Passwörter für den Zugang vergeben. Vor ein paar Tagen habe ich herausgefunden, dass man mit ihnen auch wunderbar beliebige andere Servervariablen abfragen kann.</p>
<p>Mit dem Modul <a href="https://httpd.apache.org/docs/2.2/mod/mod_setenvif.html">mod_setenvif</a> nämlich lassen sich mit Hilfe der zwei Direktiven <em>BrowserMatch</em> und <em>SetEnvIf</em> (und deren Varianten, denen Groß- und Kleinschreibung egal ist) Umgebungsvariablen abfragen und davon abhängig den Zugang zu Ressourcen regeln.</p>
<p>Ich habe das benutzt, um folgendes zu tun. Ein PHP-Dokument bindet mit <code>require</code> eine HTML-Datei ein und zwar abhängig vom Rückgabewert eines If-Statements:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (…) &#123; <span class="keyword">require</span> <span class="string">"eingebunden.html"</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>Auch wenn ich den Namen der HTML-Datei so wähle, dass er schwer erraten werden kann, möchte ich sichergehen, dass niemand einfach die Adresse der Datei in den Browser eingeben und so ihren Inhalt anzeigen kann. Das geht jetzt ziemlich einfach, indem ich eine .htaccess-Datei in das Verzeichnis lege, in dem sich die fragliche HTML-Datei befindet und sie mit diesem Inhalt versehe:</p>
<figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">SetEnvIf</span> Request_URI <span class="string">"eingebunden\.html$"</span> verboten</span><br><span class="line"><span class="attribute"><span class="nomarkup">Deny</span></span> from env=verboten</span><br></pre></td></tr></table></figure>
<p>Mit der SetEnvIf-Direktive setze ich eine Variable namens &bdquo;verboten&ldquo; genau dann wenn der <abbr title="Uniform Resource Identifier">URI</abbr>-String, den der Browser als Request gesendet hat, mit dem regulären Ausdruck <code>&quot;eingebunden\.html$&quot;</code> übereinstimmt. Als nächstes sage ich dem Server, dass er Anfragen, für die er diese Variable erzeugt hat, ablehnen soll. Versucht man jetzt die HTML-Datei direkt im Browser aufzurufen, ist das einzige, was man sieht, ein 403.</p>
<p><a href="http://flattr.com/thing/449791/-htaccess-Spielereien"><img src="http://kritikant.de/media/blogs/kritikant/flattr-badge-large.png" alt="Flattr this" title="Flattr this"></a></p>

	</div>
</article>

	

</div>

		</main>
<!--	<nav class="skip-links">
		<a title="Navigation überspringen" class="skiplink ym-skip" href="#content">Um direkt zum Hauptinhalt zu gelangen, drücken Sie Enter.</a>
	</nav>-->
	<footer class="site-footer">
		<h3 class="in-site-footer cta">Kontaktieren Sie mich</h3>
		<p class="in-site-footer">Email: <a href="mailto:contact@tobias-barth.net">contact@tobias-barth.net</a><br />
		Telefon: <a href="tel:+492215706935">+49 221 570 69 35</a></p>
		<h3 class="in-site-footer cta">Finden Sie mich</h3>
		<p class="in-site-footer"><img class="sm u-photo" src="/images/Portrait.png" alt="Mein Avatar" /><a class="sm fa fa-adn" href="https://alpha.app.net/4nduril"><span>App.net</span></a> <a class="sm fa fa-twitter" href="https://twitter.com/4nduril"><span>Twitter</span></a> <a class="sm fa fa-github-square" href="https://github.com/4nduril"><span>Github</span></a></p>
		<h3 class="in-site-footer">Impressum</h3>
		<p class="in-site-footer">Inhaltlich verantwortlich gemäß § 5 <abbr title="Telemediengesetz">TMG</abbr>:<br />
		Tobias&nbsp;Barth<br />
		Vincenzstr.&nbsp;25<br />
		51065&nbsp;Köln</p>
		<h4 class="in-site-footer">Fotos</h4>
		<p class="in-site-footer">&copy;&nbsp;<a href="http://annebarth.de">Anne&nbsp;Barth</a></p>
	</footer>

	<script src="js/tobias-barth-net.js"></script>
	<!--[if lt IE 9]>
		<script src="js/old-ie2-superweirdbehaviour.js"></script>
	<![endif]-->
</body>

</html>
